#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Select Samplerate
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Select Samplerate"
CONFIG_FILE="$HOME/.config/pipewire/pipewire.conf"

# Primary Source (as requested): Read rate from the user's config file
current_rate=$(grep 'default.clock.rate' "$CONFIG_FILE" | awk '{print $3}' | tr -d '[:space:]')

# Secondary Source (Fallback): Detect current active rate from default sink (via pactl)
if [[ -z "$current_rate" ]]; then
    default_sink=$(timeout 1 pactl info 2>/dev/null | awk -F': ' '/Default Sink/ {print $2}')
    if [[ -n "$default_sink" ]]; then
        current_rate=$(timeout 1 pactl list sinks 2>/dev/null | awk -v sink="$default_sink" '
            $0 ~ "Name: " sink {found=1}
            found && /Sample Specification:/ {print $3; exit}
        ' | cut -d'.' -f1)
    fi
fi

# Final Fallback: use first available rate if neither configuration nor active sink provides a rate
[[ -z "$current_rate" ]] && current_rate="${SAMPLE_RATES[0]}"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t              Open in terminal"
    echo "  -s SAMPLERATE   Set samplerate"
    echo "  -h              Show this help"
    echo "  -n              Show notification"
    echo "  -v              Show console message"
    exit 0
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args &
}

change() {
    RATE=$1
    RATE_LINE="default.clock.rate = $RATE"
    if grep -q 'default.clock.rate' "$CONFIG_FILE"; then
        sed -i "s|default.clock.rate.*|$RATE_LINE|" "$CONFIG_FILE"
    else
        if grep -q 'context.properties' "$CONFIG_FILE"; then
            sed -i "/context.properties/ a\\$RATE_LINE" "$CONFIG_FILE"
        else
            # If no context.properties block exists, create it with the rate
            echo -e "context.properties = {\n$RATE_LINE\n}" >> "$CONFIG_FILE"
        fi
    fi

    # 7. restart pipewire to make changes
    systemctl --user stop pipewire pipewire-pulse
    systemctl --user start pipewire pipewire-pulse
    clear
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Samplerate changed" "New samplerate $1."
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Samplerate changed\nNew samplerate $1."
    fi
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        yprint -c --color=green "Current samplerate: $current_rate"
        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        choice=$(echo -e "44100\n48000\n88200\n96000\n176400\n192000" | fzf --layout=reverse --height=$height --prompt="ï€‚  > ")
        [ -z "$choice" ] && exit 0
        change "$choice"
        printMessage "$choice"
    done
}

OPEN_TERMINAL=false
SET_TERMINAL=""

while getopts "thnvs:" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    case "$SET" in
        44100|48000|88200|96000|176400|192000) 
            change "$SET" && printMessage "$SET" ;;
        *) 
            echo "Invalid samplerate. Use one of: 44100, 48000, 88200, 96000, 176400, 192000"
            exit 1 ;;
    esac
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu