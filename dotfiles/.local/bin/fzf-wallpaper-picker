#!/usr/bin/env bash

# __   _____  _   _ _   _ _____  __
# \ \ / / _ \| | | | \ | |_ _\ \/ /
#  \ V / | | | | | |  \| || | \  /
#   | || |_| | |_| | |\  || | /  \
#   |_| \___/ \___/|_| \_|___/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

# FZF Wallpaper Picker for YOUNIX desktop environment

[ ! -d "$WALLPAPER_DIR" ] && {
    echo "❌ $WALLPAPER_DIR folder does not exist."
    exit 1
}

mkdir -p "$(dirname "$DEFAULT_SCRIPT")"

cd "$WALLPAPER_DIR" || exit

if command -v chafa &>/dev/null; then
    PREVIEW_CMD='chafa --fill=block --size=40x20 {}'
elif command -v timg &>/dev/null; then
    PREVIEW_CMD='timg -g 80x24 {}'
else
    PREVIEW_CMD='echo "! Install chafa ή timg to preview."'
fi

while true; do
    SELECTED=$(find . -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
        | sed 's|^\./||' \
        | fzf --layout=reverse --preview "$PREVIEW_CMD" \
              --preview-window=right:60%:wrap \
              --prompt="  > " \
              --height=90% \
              --border
              )

    [ -z "$SELECTED" ] && break

    feh --bg-fill --no-fehbg "$WALLPAPER_DIR/$SELECTED"

    chmod +x "$DEFAULT_SCRIPT"

    echo "✅ Επιλογή αποθηκεύτηκε: $SELECTED"
    break
done
