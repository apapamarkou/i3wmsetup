#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Power Profiles
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure Power Profiles"
PROFILES=$(powerprofilesctl list | awk -F: '
/:/ {
  gsub(/^[ \t*]+|[ \t]+$/, "", $1)
  if ($1=="performance") print "󱄟 "$1
  else if ($1=="balanced") print "⚖️ "$1
  else if ($1=="power-saver") print "󱩳 "$1
}')
CURRENT_PROFILE=$(powerprofilesctl get)


showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    AVAILABLE_PROFILES=$(echo "$PROFILES" | awk '{print $2}' | tr '\n' '|' | sed 's/|$//')
    echo "  -s           Set power profile ($(echo "$AVAILABLE_PROFILES" | tr '|' ', '))"
    echo "  -h           Show this help"
    echo "  -n           Show notification"
    echo "  -v           Show console message"
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "⚡ Power Profile Changed" "Now: $1"
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "⚡ Power Profile Changed\nNow: $1"
    fi
}

change() {
    CLEAN_PROFILE=$(echo "$1" | awk '{print $2}')
    powerprofilesctl set "$CLEAN_PROFILE"
    printMessage "$CLEAN_PROFILE"
    notify-send "⚡ Power Profile Changed" "Now: $CLEAN_PROFILE"
}

displayMenu() {
    while true; do
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        yprint -c --color=green "Current profile $CURRENT_PROFILE"
        height=$(($(tput lines) - 2))
        OPTIONS=$(echo -e "$PROFILES\n$EXIT_TEXT")
        SELECTED_PROFILE=$(echo "$OPTIONS" | \
        fzf --prompt="⚡ > " \
            --reverse --cycle --select-1 --exit-0 \
            --preview-window=up:1:noborder \
            --height=$height)

        [ -z "$SELECTED_PROFILE" ] && exit 0
        
        case "$SELECTED_PROFILE" in
            "$EXIT_TEXT") exit 0 ;;
            *) change $SELECTED_PROFILE ;;
        esac

    done
}

OPEN_TERMINAL=false
SET_MONITOR=""
EXIT_TEXT="󰈆  Exit"

while getopts "ethnvs:" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    # Extract available profiles from PROFILES variable
    AVAILABLE_PROFILES=$(echo "$PROFILES" | awk '{print $2}' | tr '\n' '|' | sed 's/|$//')
    if echo "$AVAILABLE_PROFILES" | grep -q "\b$SET\b"; then
        change "$SET"
    else
        echo "Invalid profile. Available profiles: $(echo "$AVAILABLE_PROFILES" | tr '|' ', ')"
        exit 1
    fi
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu








