#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Night Light
#

MUTE_NOTIFY=false
MUTE_ECHO=false

showHelp() {
    echo "YoUNiX Configure Night Light"
    echo "Usage: ycnightlight [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -s STATE     Set night light (on/off)"
    echo "  -h           Show this help"
    echo "  -n           Show notification"
    echo "  -v           Show console message"
    echo "Arguments can be combined: -vn, -nv, etc."
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n ~/.config/lock terminal --columns=50 --lines=15 --title="YoUNiX Control Center" ycnightlight $args > /dev/null 2>&1 &
}

redshiftChange() {
    case $1 in
        on)
            nohup start-geolocated-redshift > /dev/null 2>&1 &
            sed -i '/#exec --no-startup-id start-geolocated-redshift/s/^#//' ~/.config/i3/conf.d/startup.conf
            if [ "$MUTE_NOTIFY" = false ]; then
                notify-send "Night light Enabled" "See the system tray.\nMay take a few seconds..."
            fi
            if [ "$MUTE_ECHO" = false ]; then
                echo -e "Night light Enabled\nSee the system tray.\nMay take a few seconds..."
            fi
            ;;
        off)
            pkill redshift
            # commend out the line "exec --no-startup-id start-geolocated-redshift" from .config/i3/conf.d/startup.conf
            sed -i '/exec --no-startup-id start-geolocated-redshift/s/^/#/' ~/.config/i3/conf.d/startup.conf
            if [ "$MUTE_NOTIFY" = false ]; then
                notify-send "Night light Disabled" "Screen color temperature reset to default."
            fi
            if [ "$MUTE_ECHO" = false ]; then
                echo -e "Night light Disabled\nScreen color temperature reset to default."
            fi
            ;;
    esac
    sleep 4
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "YoUNiX Configure Night Light"
        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        # show current state
        if [ -n "$(pgrep redshift)" ]; then
            yprint -c --color=green "󰞏  Night light is enabled"
        else
            yprint -c --color=red "󱜞  Night light is disabled"
        fi
        choice=$(echo -e "󰞏  Enable\n󱜞  Disable\n󰌍  Back" | fzf --layout=reverse --height=$height --prompt="  > ")
        case $choice in
            *Enable*) redshiftChange on ;;
            *Disable*) redshiftChange off ;;
            *) exit 0 ;;
        esac
    done
}

OPEN_TERMINAL=false
SET_STATE=""

while getopts "thnvs:" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET_STATE="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET_STATE" ]; then
    case "$SET_STATE" in
        on|off) redshiftChange "$SET_STATE" ;;
        *) echo "Invalid state. Use 'on' or 'off'."; exit 1 ;;
    esac
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu
