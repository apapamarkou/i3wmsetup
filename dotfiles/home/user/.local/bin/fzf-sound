#!/usr/bin/env bash

# fzf-sound-menu.sh
# A main menu to navigate between various audio configuration scripts (fzf, mixer, etc.)

# Define the menu options and their associated commands
MENU_OPTIONS=(
    "󱡭  Audio Input:Select a specific input source (microphone, line-in)"
    "󱡫  Audio Output:Select a specific output sink (speakers, headphones)"
    "  Volume Mixer:Open the graphical or terminal mixer (pavucontrol/pamixer)"
    "  Sample Rate:Change the global PipeWire sample rate (Hz)"
    "  Buffer Size:Change the global PipeWire buffer size (quantum)"
    "󰌍  Back:Exit the menu"
)

# Convert the array into a list format for fzf, keeping the command hidden
FZF_LIST=$(
    for item in "${MENU_OPTIONS[@]}"; do
        # Split item by the colon delimiter, use the first part for display
        DISPLAY_TEXT=$(echo "$item" | cut -d: -f1)
        echo "$DISPLAY_TEXT"
    done
)

# Function to run the selected action
run_action() {
    local choice="$1"

    # Find the full option string that matches the choice's display text
    for item in "${MENU_OPTIONS[@]}"; do
        DISPLAY_TEXT=$(echo "$item" | cut -d: -f1)
        if [[ "$DISPLAY_TEXT" == "$choice" ]]; then
            # Extract the action part
            ACTION_TEXT=$(echo "$item" | cut -d: -f2)
            
            # Map the display name to the actual script/command
            case "$choice" in
                "󱡭  Audio Input")      COMMAND="fzf-sound-select-input" ;;
                "󱡫  Audio Output")     COMMAND="fzf-sound-select-output" ;;
                "  Volume Mixer")     COMMAND="sound-mixer" ;;
                "  Sample Rate")      COMMAND="fzf-sound-select-samplerate" ;;
                "  Buffer Size")      COMMAND="fzf-sound-select-buffersize" ;;
                "󰌍  Back")             COMMAND="exit 0" ;;
                *)                    COMMAND="echo 'Error: Unknown command.'" ;;
            esac
            
            eval "$COMMAND"
            
            # After running, loop the menu again (unless we chose 'Back'/'exit 0')
            if [[ "$choice" != "⬅ Back" ]]; then
                main_menu
            fi
            return # Stop processing after finding the match
        fi
    done
}

# Main menu loop function
main_menu() {
    # Prompt the user with the fzf menu
    CHOICE=$(
        echo "$FZF_LIST" | fzf \
            --prompt="  Sound Configuration > " \
            --height=50% \
            --layout=default \
            --reverse \
            --color "fg:#F8F8F2,bg:#272822,hl:#F92672,fg+:#F8F8F2,bg+:#49483E,info:#A6E22E,prompt:#AE81FF,pointer:#F92672,marker:#AE81FF,spinner:#F92672"
    )

    # Check if fzf was cancelled (e.g., via ESC or Ctrl+C)
    if [[ -z "$CHOICE" ]]; then
        echo "Menu closed."
        exit 0
    fi
    
    # Run the action associated with the choice
    run_action "$CHOICE"
}

# Start the application
main_menu
