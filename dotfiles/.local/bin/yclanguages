#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Languages
#

SCRIPT_NAME=$(basename "$0")
TITLE="Configure Languages"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=61 --lines=18 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME
}

notifyChange() {
    local VAR="$1"
    local VALUE="$2"
    local HUMAN_NAME="${HUMAN_NAMES[$VAR]:-$VAR}"
    notify-send "Language Changed" "$HUMAN_NAME is set to $VALUE"
}

changeLanguage(){

    VAR="$1"

    # Check /etc/locale.gen exists
    [[ ! -f /etc/locale.gen ]] && echo "/etc/locale.gen not found!" && exit 1

    # relative fzf height by terminal height
    height=$(($(tput lines) - 2))

    yprint -c --color=yellow "$DISTRO_NAME $TITLE"


    # Let user pick a locale from /etc/locale.gen (all lines, including commented)
    lang=$(grep -v '^#' /etc/locale.gen | awk '{print $1}' | fzf --prompt=" Select locale for $VAR > " --height=$height --layout=reverse)

    # if nothing selected
    [[ -z "$lang" ]] && return

    # Apply the selected locale to the given variable
    if grep -q "^export $VAR=" "$HOME/.profile"; then
        sed -i "s|^export $VAR=.*|export $VAR=\"$lang\"|" "$HOME/.profile"
    else
        echo "export $VAR=\"$lang\"" >> "$HOME/.profile"
    fi

}

displayMenu() {
    while true; do
        

        # List of locale variables
        LOCALE_VARS=(
            LANG
            LC_CTYPE
            LC_NUMERIC
            LC_TIME
            LC_COLLATE
            LC_MONETARY
            LC_PAPER
            LC_NAME
            LC_ADDRESS
            LC_TELEPHONE
            LC_MEASUREMENT
            LC_IDENTIFICATION
        )

        # Human-readable mapping
        declare -A HUMAN_NAMES=(
            [LANG]="  Default Language        "
            [LC_CTYPE]="󰛖  Character Classification"
            [LC_NUMERIC]="  Number Format           "
            [LC_TIME]="  Date/Time Format        "
            [LC_COLLATE]="󰒼  Sorting Order           "
            [LC_MONETARY]="󰇁  Currency Format         "
            [LC_PAPER]="󰲏  Paper Sizes             "
            [LC_NAME]="  Personal Names Format   "
            [LC_ADDRESS]="  Address Format          "
            [LC_TELEPHONE]="󰘂  Telephone Format        "
            [LC_MEASUREMENT]="󰭍  Measurement Units       "
            [LC_IDENTIFICATION]="  Identification Info     "
        )

        # Get current values and prepare fzf input
        MENU_LIST=()
        for VAR in "${LOCALE_VARS[@]}"; do
            # Check .profile first
            CURRENT=$(grep "^export $VAR=" ~/.profile 2>/dev/null | cut -d'=' -f2 | tr -d '"')
            # If not found, check /etc/locale.conf
            [[ -z "$CURRENT" ]] && CURRENT=$(grep "^$VAR=" /etc/locale.conf 2>/dev/null | cut -d'=' -f2)
            # If still not found, show "Not Set"
            [[ -z "$CURRENT" ]] && CURRENT="Not Set"
            
            MENU_LIST+=("${HUMAN_NAMES[$VAR]:-$VAR} ($CURRENT) | $VAR")
        done

        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))

        yprint -c --color=yellow "$DISTRO_NAME Select language"
        yprint -c --color=cyan "[Enter] to configure"

        # Select which locale variable to change
        SELECTION=$(
            {
                printf "%s\n" "${MENU_LIST[@]}"
                printf "󰈆  %s" "$EXIT_TEXT"
            } | fzf --prompt="  Select > " --height=$height --layout=reverse
        )
        if [ "$SELECTION" = "󰈆  $EXIT_TEXT" ]; then
            echo "Exiting script."
            exit 0
        fi

        # Exit if nothing selected
        [[ -z "$SELECTION" ]] && echo "No variable selected." && exit 0

        # Extract the real variable name (after the |)
        VAR=$(echo "$SELECTION" | awk -F'|' '{print $2}' | xargs)

        # Store old value for comparison
        OLD_VALUE=$(grep "^export $VAR=" ~/.profile 2>/dev/null | cut -d'=' -f2 | tr -d '"')
        [[ -z "$OLD_VALUE" ]] && OLD_VALUE=$(grep "^$VAR=" /etc/locale.conf 2>/dev/null | cut -d'=' -f2)
        
        # Call the previous script with the selected variable
        changeLanguage "$VAR"
        
        # Check if value changed and notify
        NEW_VALUE=$(grep "^export $VAR=" ~/.profile 2>/dev/null | cut -d'=' -f2 | tr -d '"')
        if [[ "$NEW_VALUE" != "$OLD_VALUE" && -n "$NEW_VALUE" ]]; then
            notifyChange "$VAR" "$NEW_VALUE"
        fi       
    done
}

OPEN_TERMINAL=false
EXIT_TEXT="Exit"

while getopts "the" opt; do
    case $opt in
        e) EXIT_TEXT="Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu