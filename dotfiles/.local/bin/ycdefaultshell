#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Select Default Shell
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Select Default Shell"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -s SHELL     Set default shell"
    echo "  -h           Show this help"
    echo "  -n           Mute notification"
    echo "  -e           Embedded mode"
    echo "  -v           Mute console message"
    echo "Arguments can be combined: -vn, -nv, etc."
    exit 0
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Shell changed to $1" "This setting will be available at the next login."
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Shell changed to $1.\nThis setting will be available at the next login."
    fi
}

change(){
    case $1 in
            bash) chsh -s /bin/bash ;;
            zsh) chsh -s /usr/bin/zsh ;;
            fish) chsh -s /usr/bin/fish ;;
            *) echo "Invalid shell. Use 'bash', 'zsh', or 'fish'."; exit 1 ;;
    esac
    printMessage $1
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME Select Default Shell"
        # current default shell
        current=$(echo $SHELL | awk -F/ '{print $NF}')
        yprint -c --color=green "Current default shell: $current"
        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        choice=$(echo -e "  bash\n  zsh\n  fish\n$EXIT_TEXT" | fzf --layout=reverse --height=$height --prompt="  Shell: ")
        case $choice in
            *bash*) change bash ;;
            *zsh*) change zsh;;
            *fish*) change fish;;
            *) exit 0 ;;
        esac
    done
}

OPEN_TERMINAL=false
SET_SHELL=""
EXIT_TEXT="󰈆  Exit"

while getopts "ethnvs:" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET_SHELL="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET_SHELL" ]; then
    change "$SET_SHELL"
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu
