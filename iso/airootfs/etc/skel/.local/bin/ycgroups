#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Groups
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure Groups"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
    echo "  -n    Mute notification"
    echo "  -v    Mute console message"
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n ~/.config/lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Group Management" "$1"
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Group Management\n$1"
    fi
}

addGroup() {
    read -e -p"Enter new group name: " group_name
    if [ -n "$group_name" ]; then
        sudo groupadd "$group_name" 2>/dev/null
        if [ $? -eq 0 ]; then
            printMessage "Group '$group_name' created successfully"
        else
            printMessage "Failed to create group '$group_name'"
        fi
    fi
}

removeGroup() {
    local group="$1"
    choice=$(echo -e "Approve\nDecline" | fzf --layout=reverse --prompt="Remove group '$group'? " --height=30%)
    
    if [ "$choice" = "Approve" ]; then
        sudo groupdel "$group" 2>/dev/null
        if [ $? -eq 0 ]; then
            printMessage "Group '$group' removed successfully"
        else
            printMessage "Failed to remove group '$group'"
        fi
    fi
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        height=$(($(tput lines) - 1))

        # Get all available groups and add management options
        all_groups=$(cut -d: -f1 /etc/group | sort)
        options=$(echo -e "  Add Group\n󰌍  Back\n$all_groups")
        
        choice=$(echo "$options" | fzf --layout=reverse --prompt="  Select > " --height=$height)
        [ -z "$choice" ] && exit 0
        
        case "$choice" in
            *Group*) addGroup ;;
            *Back*) exit 0 ;;
            *) removeGroup "$choice" ;;
        esac
    done
}

OPEN_TERMINAL=false

while getopts "thnv" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu