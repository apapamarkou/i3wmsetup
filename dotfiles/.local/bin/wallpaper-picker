#!/usr/bin/env bash

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
DEFAULT_SCRIPT="$HOME/.config/i3/script/set-default-wallpaper"

# Έλεγξε αν υπάρχει ο φάκελος
[ ! -d "$WALLPAPER_DIR" ] && {
    echo "❌ $WALLPAPER_DIR folder does not exist."
    exit 1
}

mkdir -p "$(dirname "$DEFAULT_SCRIPT")"

cd "$WALLPAPER_DIR" || exit

# Έλεγξε αν έχεις chafa ή timg για preview
if command -v chafa &>/dev/null; then
    PREVIEW_CMD='chafa --fill=block --size=40x20 {}'
elif command -v timg &>/dev/null; then
    PREVIEW_CMD='timg -g 80x24 {}'
else
    PREVIEW_CMD='echo "! Install chafa ή timg to preview."'
fi

while true; do
    SELECTED=$(find . -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
        | sed 's|^\./||' \
        | fzf --layout=reverse --preview "$PREVIEW_CMD" \
              --preview-window=right:60%:wrap \
              --prompt="  > " \
              --height=90% \
              --border
              )

    [ -z "$SELECTED" ] && break

    feh --bg-fill "$WALLPAPER_DIR/$SELECTED"

    # Δημιουργία του script για εκκίνηση
    cat > "$DEFAULT_SCRIPT" <<EOF
#!/bin/bash
feh --bg-fill "$WALLPAPER_DIR/$SELECTED"
EOF

    chmod +x "$DEFAULT_SCRIPT"

    echo "✅ Επιλογή αποθηκεύτηκε: $SELECTED"
    break
done
