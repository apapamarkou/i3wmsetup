#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX GRUB Install
#

SCRIPT_NAME=$(basename "$0")
TITLE="GRUB Install"

AVAILABLE_DRIVES=$(lsblk -d -o NAME,SIZE,MODEL | grep -E '^[a-z]' | awk '{print "/dev/" $1 " (" $2 " " $3 ")"}')

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -d DRIVE  Install GRUB on specified drive (e.g., /dev/sda)"
    echo "  -t        Open in terminal"
    echo "  -h        Show this help"
    echo ""
    echo "Available drives:"
    echo "$AVAILABLE_DRIVES"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=50 --lines=10 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

SELECTED_DRIVE=""

selectDrive() {
    SELECTED_DRIVE=$(echo "$AVAILABLE_DRIVES" | fzf \
        --layout=reverse \
        --prompt="ðŸ’½ Select drive > " \
        --height=50%)
    
    [[ -n "$SELECTED_DRIVE" ]] && SELECTED_DRIVE=$(echo "$SELECTED_DRIVE" | awk '{print $1}')
}

installGrub() {
    [[ -z "$SELECTED_DRIVE" ]] && { yprint --color=red "No drive selected"; read -p "Press Enter..."; return; }
    
    clear
    yprint -c --color=yellow "Installing GRUB to $SELECTED_DRIVE"
    echo
    
    # Install grub package if not installed
    if ! pacman -Q grub &>/dev/null; then
        yprint --color=cyan "Installing GRUB package..."
        sudo pacman -S --noconfirm grub
    fi
    
    # Install GRUB to disk
    yprint --color=cyan "Installing GRUB bootloader..."
    sudo grub-install --target=i386-pc "$SELECTED_DRIVE"
    
    if [[ $? -eq 0 ]]; then
        yprint --color=green "GRUB installed successfully!"
        
        # Generate GRUB config
        yprint --color=cyan "Generating GRUB configuration..."
        sudo grub-mkconfig -o /boot/grub/grub.cfg
        
        if [[ $? -eq 0 ]]; then
            yprint --color=green "GRUB configuration generated successfully!"
        else
            yprint --color=red "Failed to generate GRUB configuration"
        fi
    else
        yprint --color=red "Failed to install GRUB"
    fi
    
    echo
    read -p "Press Enter to continue..."
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        local drive_option="ó°‹Š  Select Drive"
        [[ -n "$SELECTED_DRIVE" ]] && drive_option="ó°‹Š  Select a different drive"
        
        local options="$drive_option"
        [[ -n "$SELECTED_DRIVE" ]] && options="$options\nï…­  Install GRUB in $SELECTED_DRIVE"
        options="$options\nó°Œ Back"
        
        height=$(($(tput lines) - 1))
        
        choice=$(echo -e "$options" | fzf \
            --layout=reverse \
            --prompt="ï€‚  Select > " \
            --height=$height)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Select Drive"*|*"Select a different drive"*)
                selectDrive
                ;;
            *"Install GRUB"*)
                installGrub
                ;;
            *"Back"*)
                exit 0
                ;;
        esac
    done
}

OPEN_TERMINAL=false
DIRECT_DRIVE=""

while getopts "d:th" opt; do
    case $opt in
        d) DIRECT_DRIVE="$OPTARG" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ -n "$DIRECT_DRIVE" ]]; then
    # Validate drive exists
    if [[ ! -b "$DIRECT_DRIVE" ]]; then
        yprint --color=red "Error: $DIRECT_DRIVE is not a valid block device"
        echo ""
        echo "Available drives:"
        echo "$AVAILABLE_DRIVES"
        exit 1
    fi
    
    SELECTED_DRIVE="$DIRECT_DRIVE"
    installGrub
    exit 0
fi

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu