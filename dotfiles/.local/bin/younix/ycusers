#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Users
#

SCRIPT_NAME=$(basename "$0")
TITLE="Configure Users"

showHelp() {
    echo "YoUNiX $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=80 --lines=25 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

getUserInfo() {
    username=${1//\"/}   # remove double quotes
    username=${username//\'/} # remove single quotes

    if [[ "$username" == "  Add User" ]]; then
        yprint --color=green "Add User option"
        echo ""
        yprint --color=cyan "Description:"
        echo "Add a new user to your system."
        return
    fi

    if [[ "$username" == "󰌍  Back" ]]; then
        yprint --color=green "Back option"
        echo ""
        yprint --color=cyan "Description:"
        echo "Return to the previous menu or exit."
        return
    fi

    local passwd_entry
    local uid gid fullname homedir shell groups lastlogin du_cron procs

    # Βασικές πληροφορίες από /etc/passwd
    passwd_entry=$(getent passwd "$username")
    if [[ -z "$passwd_entry" ]]; then
        echo "User '$username' not found"
        return
    fi

    uid=$(echo "$passwd_entry" | cut -d: -f3)
    gid=$(echo "$passwd_entry" | cut -d: -f4)
    fullname=$(echo "$passwd_entry" | cut -d: -f5)
    homedir=$(echo "$passwd_entry" | cut -d: -f6)
    shell=$(echo "$passwd_entry" | cut -d: -f7)

    # Groups
    groups=$(id -nG "$username" | tr ' ' '\n' | sort | tr '\n' ' ')

    # Last login
    lastlogin=$(lastlog -u "$username" | awk 'NR==2 {print $4, $5, $6, $7}')

    # Disk usage
    if [[ -d "$homedir" ]]; then
        du_cron=$(du -sh "$homedir" 2>/dev/null | cut -f1)
    else
        du_cron="N/A"
    fi

    # Cron jobs
    if crontab -l -u "$username" >/dev/null 2>&1; then
        cronjobs=$(crontab -l -u "$username" | wc -l)
    else
        cronjobs=0
    fi

    # Τρέχουσες διαδικασίες
    procs=$(ps -u "$username" --no-headers | wc -l)

    # Εκτύπωση “κάρτας”
    cat <<EOF
User:       $username
Full Name:  $fullname
UID/GID:    $uid / $gid
Home Dir:   $homedir
Shell:      $shell
Groups:     $groups
Last Login: $lastlogin
Disk Usage: $du_cron
Cron Jobs:  $cronjobs
Processes:  $procs
EOF
}

inputKey() {
    local allowed="$1"
    local key
    
    while true; do
        read -n1 -s -r -p "" key
        # echo -ne "\r\033[K"
        if [[ $key =~ ^[$allowed]$ ]]; then
            echo "$key"
            break
        fi
    done
}


addUser() {

    ##################
    # User Full Name
    ##################

    local fullname username
    while true; do
        clear
        yprint -c --color=yellow "Add User"
        yprint -c --color=green "Enter the new users full name."
        echo "The name sould contain only alphabet characters and spaces"
        echo
        read -e -p "Enter full name: " fullname
        echo

        # remove any non alphabetic UTF-8 characters and spaces more than one in a raw
        fullname=$(echo "$fullname" | sed -E 's/[^[:alpha:][:space:]]+//g; s/  */ /g')
        # trim spaces
        fullname=$(echo "$fullname" | sed 's/^ *//;s/ *$//')
        
        # if empty
        if [ -z "$fullname" ]; then
            yprint --color=red "No valid chars found..."
            yprint --color=green "[A]bort or [R]etry?"
            key=$(inputKey "RrAa")
            [[ $key == [Rr] ]] && continue
            [[ $key == [Aa] ]] && return
        fi

        # show the full name stripped and confirm
        yprint --color=yellow "Full name: '$fullname'"

        # confirm
        yprint --color=green "[Y]es, [R]etry, [A]bort"
        key=$(inputKey "YyNnRrAa")
        [[ $key == [Yy] ]] && break
        [[ $key == [Rr] ]] && continue
        [[ $key == [Aa] ]] && return
            
    done

    #####################
    # Username
    #####################

    while true; do
        clear
        yprint -c --color=yellow "Add User"
        yprint -c --color=green "Enter a username."
        yprint -c "The name sould contain only standard ASCII characters."
        echo
        read -e -p "Enter username: " username
        echo
        echo "Checking input and removing illegal chars"

        # remove any non alphabetic/numeric characters and spaces
        username=$(echo "$username" | sed 's/[^a-zA-Z0-9_-]//g')
        yprint -c --color=yellow "Username: '$username'"

        # if empty
        if [ -z "$username" ]; then
            yprint --color=red "No valid chars found..."
            yprint --color=green "[A]bort or [R]etry?"
            key=$(inputKey "RrAa")
            [[ $key == [Rr] ]] && continue
            [[ $key == [Aa] ]] && return
        fi

        # show the full name stripped and confirm
        yprint --color=yellow "Username: '$username'"

        # confirm
        yprint --color=green "[Y]es, [R]etry, [A]bort"
        key=$(inputKey "YyRrAa")
        [[ $key == [Yy] ]] && break
        [[ $key == [Rr] ]] && continue
        [[ $key == [Aa] ]] && return
    done

    while true; do
        clear
        yprint -c --color=yellow "Add User"
        yprint -c --color=green "Password for $username."
        yprint -c "The passowrd must be strong"
        yprint -c "Should contain at least:"
        yprint -c "at least 8 characters"
        yprint -c "1 lowercase"
        yprint -c "1 uppercase"
        yprint -c "1 number"
        yprint -c "1 specia"
        yprint -c "l char"
        echo
        read -e -p "Enter password: " password
        echo
        echo "Checking passord.."
        echo

        ERRORS=0
        # if containing spaces show error and continueadd ERRORS
        if [[ "$password" =~ [[:space:]] ]]; then
            yprint --color=red "password cannot contain spaces!"
            ((ERRORS++))
        fi
        # if not containing uppercase show error and continue
        if ! [[ "$password" =~ [A-Z] ]]; then
            yprint --color=red "password must contain at least one uppercase letter!"
            ((ERRORS++))
        fi
        # if not containing lowercase show error and continue
        if ! [[ "$password" =~ [a-z] ]]; then
            yprint --color=red "password must contain at least one lowercase letter!"
            ((ERRORS++))
        fi
        # if not containing number show error and continue
        if ! [[ "$password" =~ [0-9] ]]; then
            yprint --color=red "password must contain at least one number!"
            ((ERRORS++))
        fi
        # if not containing special char show error and continue
        if ! [[ "$password" =~ [[:punct:]] ]]; then
            yprint --color=red "password must contain at least one special character!"
            ((ERRORS++))
        fi
        # if length less than 8 show error and continue
        if [ ${#password} -lt 8 ]; then
            yprint --color=red "password must be at least 8 characters long!"
            ((ERRORS++))
        fi

        # if there were errors read keyboard no fzf press Y to continue or A abort
        # loop while get a valid answer 
        if [ $ERRORS -gt 0 ]; then
            echo "$ERRORS errors found."
            echo "[R]etry, [A]bort"
            key=$(inputKey "RrAa")
            [[ $key == [Rr] ]] && continue
            [[ $key == [Aa] ]] && return 
        else
            break
        fi
    done

    while true; do
        clear
        read -s -p "Confirm password: " confirm_password
        echo
        if [ "$password" != "$confirm_password" ]; then
            echo "Passwords do not match!"
            echo "[R]etry, [A]bort"
            key=$(inputKey "RrAa")
            [[ $key == [Rr] ]] && continue
            [[ $key == [Aa] ]] && return 
        fi
    done

    
    clear
    # ask for administration
    local admin=false
    yprint -c --color=yellow "Add User"
    echo
    echo "Should the user '$username' have sudo administration [Y]es/[N]o?"
    key=$(inputKey "YyNn")
    [[ $key == [Yy] ]] && admin=true
    
    clear
    yprint -c --color=yellow "Creating User"
    echo "Full Name : $fullname"
    echo "Username  : $username"
    if [ "$admin" = true ]; then
        echo "Administration : Yes"
    else
        echo "Administration : No"
    fi
    echo
    echo "Creating user..."
    sudo useradd -m -c "$fullname" "$username"
    echo "Setting password..."
    echo "$username:$password" | sudo chpasswd
    echo "Setting shell..."
    sudo usermod -s /bin/bash "$username"
    # add default groups
    sudo usermod -aG user "$username"
    sudo usermod -aG video "$username"
    if [ "$admin" = true ]; then
        sudo usermod -aG wheel "$username"
        echo "Granted sudo administration..."
    fi
    echo
    if [ $? -eq 0 ]; then
        echo "  User '$username' created successfully!"
    else
        echo "  Failed to create user '$username'"
    fi
}

deleteUser() {
    local username="$1"
    yprint --color=yellow -c "Delete User $username"
    choice=$(echo -e "Approve\nDecline" | fzf --layout=reverse --prompt="Delete user '$username'? " --height=30%)
    
    if [ "$choice" = "Approve" ]; then
        echo "󰆴  Deleting user '$username'..."
        echo "  Archiving user directory to  /home/archives/$username..."
        # archive user directory
        archive_dir="/home/archives/$username"
        sudo mkdir -p "/home/archives"
        sudo tar -czf "$archive_dir.tar.gz" "/home/$username" 2
        # delete user
        # sudo userdel -r "$username" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "  User '$username' deleted successfully!"
        else
            echo "  Failed to delete user '$username'"
        fi
        read -p "Press Enter to continue..."
    fi
}

editUser() {
    local username="$1"
    height=$(($(tput lines) - 1))

    while true; do
        yprint --color=yellow -c "Edit User $username"
        choice=$(echo -e "  Edit Full Name\n󰌇  Change Password\n  User Groups\n󰆴  Delete User\n󰌍  Back" | fzf --layout=reverse --prompt="Edit $username > " --height=$height)
        [ -z "$choice" ] && break
        
        case "$choice" in
            *"Edit Full Name"*)
                current_fullname=$(getent passwd "$username" | cut -d: -f5)
                read -e -p "Enter full name: " -i "$current_fullname" new_fullname
                sudo usermod -c "$new_fullname" "$username"
                ;;
            *"Change Password"*)
                read -s -p "Enter new password: " new_password
                echo
                echo "$username:$new_password" | sudo chpasswd
                echo "Password changed successfully!"
                read -p "Press Enter to continue..."
                ;;
            *"User Groups"*)
                editUserGroups "$username"
                ;;
            *"Delete User"*)
                deleteUser "$username"
                ;;
            *"Back"*) break ;;
        esac
    done
}

editUserGroups() {
    local username="$1"
    
    while true; do
        user_groups=$(groups "$username" 2>/dev/null | cut -d: -f2 | tr ' ' '\n' | grep -v '^$' | sort)
        options=$(echo -e "  Add to a Group\n$user_groups\n󰌍  Back")
        height=$(($(tput lines) - 1))

        choice=$(echo "$options" | fzf --layout=reverse --prompt="Groups for $username > " --height=$height)
        [ -z "$choice" ] && break
        
        case "$choice" in
            *"Add to a Group"*)
                all_groups=$(cut -d: -f1 /etc/group | sort)
                available_groups=$(comm -23 <(echo "$all_groups") <(echo "$user_groups"))
                height=$(($(tput lines) - 1))

                group=$(echo "$available_groups" | fzf --layout=reverse --prompt="Add $username to group > " --height=$height)
                if [ -n "$group" ]; then
                    sudo usermod -a -G "$group" "$username"
                    echo "Added $username to group $group"
                    read -p "Press Enter to continue..."
                fi
                ;;
            *"Back"*) break ;;
            *)
                # Remove from group
                confirm=$(echo -e "Remove\nCancel" | fzf --layout=reverse --prompt="Remove $username from $choice? " --height=30%)
                if [ "$confirm" = "Remove" ]; then
                    sudo gpasswd -d "$username" "$choice"
                    echo "Removed $username from group $choice"
                    read -p "Press Enter to continue..."
                fi
                ;;
        esac
    done
}

displayMenu() {
    while true; do
        clear
        height=$(($(tput lines) - 1))
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"

        # Get all users and add management option
        users=$(awk -F: '$3>=1000 && $3!=65534 {print $1}' /etc/passwd | grep -v '^_' | sort)
        options=$(echo -e "$users\n  Add User\n󰌍  Back")
        
        choice=$(echo "$options" | fzf \
            --layout=reverse \
            --prompt="  Select > " \
            --height=$height \
            --bind='ctrl-a:select-all,ctrl-d:deselect-all' \
            --preview='bash -c "getUserInfo \"{}\" "' \
            --preview-window=right:70%:wrap)
        
        [ -z "$choice" ] && exit 0
        
        case "$choice" in
            *"Add User"*) addUser ;;
            *"Back"*) return ;;
            *) editUser "$choice" ;;
        esac
    done
}

# Export function for fzf preview
export -f getUserInfo

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu