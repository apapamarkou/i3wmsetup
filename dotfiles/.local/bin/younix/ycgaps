#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure I3 window gaps
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure I3 window gaps"

showHelp() {
    echo "YoUNiX $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -s           Set theme (tight/separated/loose)"
    echo "  -h           Show this help"
    echo "  -n           Show notification"
    echo "  -v           Show console message"
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Window gaps changed to $1" "Some changees will be available at the next login."
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Window gaps changed to $1.\nSome changes will be available at the next login."
    fi
}

change() {
    
    case $1 in
        tight)
            gapSize=0 ;;
        separated)
            gapSize=5 ;;
        loose)
            gapSize=15 ;;
    esac
    # apply setting immediately
    i3-msg "gaps inner all set $gapSize; gaps outer all set 0"  >/dev/null 2>&1 &
    #replace $HOME/.config/i3/config gaps inner value with gapSize
    sed -i "s/gaps inner [0-9]*px/gaps inner ${gapSize}px/" "$HOME/.config/i3/config"
}

displayMenu() {
    while true; do
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        # get current gaps from conf and convert to word
        current_px=$(grep 'gaps inner' "$HOME/.config/i3/config" | awk '{print $3}')
        case "$current_px" in
            0px) current_word="Tight (no gaps)" ;;
            5px) current_word="Separated (small gaps)" ;;
            15px) current_word="Loose (large gaps)" ;;
            *) current_word="Custom ($current_px)" ;;
        esac
        
        yprint -c "Current setting: $current_word"
        
        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        choice=$(echo -e "󰎦  Tight (no gaps)\n󰎩  Separated (small gaps)\n󰎬  Loose (large gaps)\n󰌍  Back" | fzf --layout=reverse --prompt="  Gaps > " --height=$height)
        case "$choice" in
            *Tight*) change tight ;;
            *Separated*) change separated ;;
            *Loose*) change loose ;;
            *) break ;;

        esac
    done
}

OPEN_TERMINAL=false
SET_MONITOR=""

while getopts "thnvs:" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    case "$SET" in
        tight|separated|loose) change "$SET" ;;
        *) echo "Invalid gap size. Use 'tight', 'separated', or 'loose'."; exit 1 ;;
    esac
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu
