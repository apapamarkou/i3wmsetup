#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Application Launcher
#

APPS_DIR="$HOME/.config/yapps"
APPS_FILE="$APPS_DIR/apps.list"
SCRIPT_NAME=$(basename "$0")
TITLE="Application Launcher"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

open_terminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=100 --lines=20 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME
}

# Get package info from pacman
get_package_info() {
    local exec_name="$1"
    # Extract first word from exec command
    local binary=$(echo "$exec_name" | awk '{print $1}' | xargs basename)
    
    # Query pacman for package info
    local pkg_name=$(pacman -Qo "/usr/bin/$binary" 2>/dev/null | awk '{print $5}')
    if [ -n "$pkg_name" ]; then
        local description=$(pacman -Qi "$pkg_name" 2>/dev/null | grep "^Description" | cut -d':' -f2- | sed 's/^ *//')
        local url=$(pacman -Qi "$pkg_name" 2>/dev/null | grep "^URL" | cut -d':' -f2- | sed 's/^ *//')
        echo "$pkg_name|$description|$url"
    else
        echo "||"
    fi
}

# Scan and cache applications
scan_apps() {
    mkdir -p "$APPS_DIR"
    find /usr/share/applications ~/.local/share/applications -name "*.desktop" 2>/dev/null | \
    while read -r desktop_file; do
        name=$(grep "^Name=" "$desktop_file" | head -1 | cut -d'=' -f2-)
        exec=$(grep "^Exec=" "$desktop_file" | head -1 | cut -d'=' -f2-)
        comment=$(grep "^Comment=" "$desktop_file" | head -1 | cut -d'=' -f2-)
        
        # Skip if no name or exec
        [ -z "$name" ] || [ -z "$exec" ] && continue
        
        # Get package info from pacman
        pkg_info=$(get_package_info "$exec")
        pkg_name=$(echo "$pkg_info" | cut -d'|' -f1)
        pkg_desc=$(echo "$pkg_info" | cut -d'|' -f2)
        pkg_url=$(echo "$pkg_info" | cut -d'|' -f3)
        
        # Use package description if available, otherwise use desktop comment
        final_desc="${pkg_desc:-${comment:-No description}}"
        
        # Format: name|exec|description|url|package|desktop_file
        echo "$name|$exec|$final_desc|$pkg_url|$pkg_name|$desktop_file"
    done | sort > "$APPS_FILE"
}

# Get apps from cache or scan if not exists
get_apps() {
    if [ ! -f "$APPS_FILE" ]; then
        scan_apps
    fi
    cat "$APPS_FILE"
}

# Main launcher with rescan option
launcher() {
    # Add rescan option to menu
    apps_with_rescan=$(echo "î«’  Rescan Applications|rescan|Refresh application list|rescan" && get_apps)
    
    selected=$(echo "$apps_with_rescan" | fzf \
        --delimiter='|' \
        --with-nth=1 \
        --preview='echo "Application: {1}" && echo "Command: {2}" && echo "" && echo "Description:" && echo "{3}" && echo "" && echo "URL: {4}" && echo "" && echo "Package: {5}"' \
        --preview-window=right:50%:wrap \
        --prompt="  Launch > " \
        --height=90% \
        --layout=reverse)
    
    if [ -n "$selected" ]; then
        exec_cmd=$(echo "$selected" | cut -d'|' -f2)
        desktop_file=$(echo "$selected" | cut -d'|' -f6)
        
        if [ "$exec_cmd" = "rescan" ]; then
            scan_apps
            launcher  # Restart launcher with updated list
        else
            # Try different launch methods
            desktop_id=$(basename "$desktop_file")
            
            # Method 1: Try gio launch
            if command -v gio >/dev/null 2>&1; then
                setsid gio launch "$desktop_file" >/dev/null 2>&1 &
            # Method 2: Try gtk-launch
            elif command -v gtk-launch >/dev/null 2>&1; then
                setsid gtk-launch "$desktop_id" >/dev/null 2>&1 &
            # Method 3: Parse and execute directly
            else
                # Clean exec command (remove %f, %F, %u, %U etc.)
                clean_exec=$(echo "$exec_cmd" | sed 's/%[fFuU]//g' | sed 's/"//g')
                setsid bash -c "$clean_exec" >/dev/null 2>&1 &
            fi
            sleep 0.1
        fi
    fi
}

# Handle command line options

OPEN_TERMINAL=false

while getopts "rht" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        r) scan_apps; echo "Applications rescanned."; exit 0 ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    open_terminal
    exit 0
fi

launcher