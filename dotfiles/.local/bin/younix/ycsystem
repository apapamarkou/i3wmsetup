#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Control Center System Mainenance
#

show_help() {
    echo "YoUNiX Control Center"
    echo "Usage: ycc [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

open_terminal() {
    flock -n ~/.config/lock terminal --columns=55 --lines=17 --title="YoUNiX System Maintenance" ycc
}

open() {
    # if this was run with -t option then open $1 in a terminal
    if [ "$OPEN_TERMINAL" = true ]; then
        flock -n ~/.config/lock terminal --columns=120 --lines=30 --title="YoUNiX System Maintenance" "$1"
    else
        clear
        "$1"
    fi
}

display_menu() {
    while true; do
        yprint -c --color=yellow "YoUNiX System Maintenance"

        # relative fzf height by terminal height
        height=$(($(tput lines) - 1))

        choice=$(echo -e "󰚰  Update System\n󱣡  System Malware Shield\n󰿞  Clean Unused Packages\n  Inspect & Free Space\n󰁨  Fix Keyring\n󰌍  Back" | fzf --layout=reverse --prompt="  Maintenance > " --height=$height)
        
        case "$choice" in
            *Update*) openModule "Mainenance: System Update" ysystemupdate ;;
            *Clean*) openModule "Mainenance: Clean orphaned packages" clean-orphaned ;;
            *Keyring*) openModule "Mainenance: Fix Keyring" fix-keyring ;;
            *Space*) openModule "Mainenance: Inspect and Free Space" "dua i $HOME" ;;
            *Malware*) openModule "Mainenance: System Malware Shield" update-shield;;
            *) break ;;
        esac
    done
}

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) show_help; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    open_terminal
    exit 0
fi

display_menu