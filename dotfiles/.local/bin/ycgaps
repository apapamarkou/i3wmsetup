#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Hyprland window gaps
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure Hyprland window gaps"

Tight=2
Separated=5
Loose=10

# --- Hyprland Specific Variables ---
HYPRLAND_CONFIG_FILE="$HOME/.config/hypr/look.conf"

showHelp() {
    echo "$TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal (functionality not implemented in this Hyprland conversion)"
    echo "  -s           Set theme (tight/separated/loose)"
    echo "  -h           Show this help"
    echo "  -n           Suppress notification"
    echo "  -v           Suppress console message"
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=61 --lines=18 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Window gaps changed to $1" "Configuration updated in $HYPRLAND_CONFIG_FILE."
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Window gaps changed to $1.\nConfiguration updated in $HYPRLAND_CONFIG_FILE."
    fi
}

change() {
    local gap_in_size=0
    local gap_out_size=0
    local set_name="$1"

    case "$set_name" in
        tight)
            gap_in_size=$Tight
            gap_out_size=4
            ;;
        separated)
            gap_in_size=$Separated
            gap_out_size=10
            ;;
        loose)
            gap_in_size=$Loose
            gap_out_size=20
            ;;
        *)
            echo "Invalid gap setting: $set_name. Use 'tight', 'separated', or 'loose'."
            exit 1
            ;;
    esac

    # Apply setting immediately using hyprctl
    # We set both inner (gaps_in) and outer (gaps_out) gaps
    hyprctl keyword general:gaps_in "$gap_in_size" > /dev/null 2>&1
    hyprctl keyword general:gaps_out "$gap_out_size" > /dev/null 2>&1

    # Function to replace or add a Hyprland keyword in the config file
    update_hyprland_config() {
        local key="$1"
        local value="$2"
        local config_file="$HYPRLAND_CONFIG_FILE"

        if grep -q "^\s*${key}\s*=" "$config_file"; then
            # Replace existing line (handles potential whitespace before the key)
            sed -i "s/^\s*${key}\s*=.*/${key} = ${value}/" "$config_file"
        else
            # If the key isn't found, append it to the end of the file
            echo -e "\n${key} = ${value}" >> "$config_file"
        fi
    }

    # Replace/Add general:gaps_in value
    update_hyprland_config "general:gaps_in" "$gap_in_size"
    
    # Replace/Add general:gaps_out value
    update_hyprland_config "general:gaps_out" "$gap_out_size"
    
    printMessage "$set_name"
}

get_current_gap() {
    # Get current gaps_in from config file, falling back to 0 if not found
    local current_px=$(grep -oP '^\s*general:gaps_in\s*=\s*\K[0-9]+' "$HYPRLAND_CONFIG_FILE" 2>/dev/null | tail -n 1)
    current_px=${current_px:-0} # Default to 0 if no value is found

    case "$current_px" in
        $Tight) echo "Tight (no gaps)" ;;
        $Separated) echo "Separated (small gaps)" ;;
        $Loose) echo "Loose (large gaps)" ;;
        *) echo "Custom ($current_px)" ;;
    esac
}

displayMenu() {
    if ! command -v fzf &> /dev/null; then
        echo "Error: fzf is required for the interactive menu but is not installed."
        exit 1
    fi
    
    while true; do
        yprint -c --color=yellow "$TITLE"
        
        current_word=$(get_current_gap)
        
        yprint -c --color=green "Current setting: $current_word"
        
        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        choice=$(echo -e "󰎦  Tight\n󰎩  Separated\n󰎬  Loose\n$EXIT_TEXT" | fzf --layout=reverse --prompt="  Gaps > " --height=$height)
        
        case "$choice" in
            *Tight*) change tight ;;
            *Separated*) change separated ;;
            *Loose*) change loose ;;
            *) break ;;

        esac
    done
}

OPEN_TERMINAL=false
SET=""
EXIT_TEXT="󰈆  Exit"

while getopts "thnvse" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    change "$SET"
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu