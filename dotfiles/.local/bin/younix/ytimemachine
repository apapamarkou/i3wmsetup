#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Time Machine
#

SCRIPT_NAME=$(basename "$0")
TITLE="Time Machine"
CONFIG_DIR="$HOME/.config/ytimemachine"
CONFIG_FILE="$CONFIG_DIR/config"

# Default values
DESTINATION=""
DAILY_ENABLED=false
WEEKLY_ENABLED=false
MONTHLY_ENABLED=false
DAILY_BACKUPS=7
WEEKLY_BACKUPS=4
MONTHLY_BACKUPS=12

showHelp() {
    echo "YoUNiX $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=120 --lines=40 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

loadConfig() {
    mkdir -p "$CONFIG_DIR"
    [[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"
}

saveConfig() {
    cat > "$CONFIG_FILE" << EOF
DESTINATION="$DESTINATION"
DAILY_ENABLED=$DAILY_ENABLED
WEEKLY_ENABLED=$WEEKLY_ENABLED
MONTHLY_ENABLED=$MONTHLY_ENABLED
DAILY_BACKUPS=$DAILY_BACKUPS
WEEKLY_BACKUPS=$WEEKLY_BACKUPS
MONTHLY_BACKUPS=$MONTHLY_BACKUPS
EOF
}

selectDestination() {
    local choice=$(echo -e "ðŸ“ Browse for folder\nðŸ’¾ Enter path manually" | fzf --layout=reverse --prompt="Select destination method > " --height=30%)
    
    case "$choice" in
        *"Browse"*)
            DESTINATION=$(find /mnt /media /home -maxdepth 3 -type d 2>/dev/null | fzf --layout=reverse --prompt="Select backup destination > " --height=50%)
            ;;
        *"Enter path"*)
            read -p "Enter backup destination path: " DESTINATION
            ;;
    esac
    
    [[ -n "$DESTINATION" ]] && {
        mkdir -p "$DESTINATION/ytimemachine"
        DESTINATION="$DESTINATION/ytimemachine"
        saveConfig
        yprint --color=green "Destination set to: $DESTINATION"
        read -p "Press Enter to continue..."
    }
}

createSnapshot() {
    [[ -z "$DESTINATION" ]] && { yprint --color=red "No destination selected"; read -p "Press Enter..."; return; }
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local snapshot_name="snapshot-$timestamp"
    local snapshot_path="$DESTINATION/$snapshot_name"
    
    # Find latest snapshot for hardlinks
    local latest_snapshot=$(ls -1t "$DESTINATION"/snapshot-* 2>/dev/null | head -1)
    
    yprint --color=yellow "Creating snapshot: $snapshot_name"
    echo
    
    # Build rsync command
    local rsync_cmd="rsync -avH --progress --delete"
    rsync_cmd="$rsync_cmd --exclude={'/dev/*','/proc/*','/sys/*','/tmp/*','/run/*','/mnt/*','/media/*','/lost+found'}"
    
    [[ -n "$latest_snapshot" ]] && rsync_cmd="$rsync_cmd --link-dest=$latest_snapshot"
    
    rsync_cmd="$rsync_cmd / $snapshot_path/"
    
    eval $rsync_cmd
    
    if [[ $? -eq 0 ]]; then
        yprint --color=green "Snapshot created successfully!"
    else
        yprint --color=red "Snapshot creation failed!"
    fi
    
    read -p "Press Enter to continue..."
}

toggleDaily() {
    if [[ "$DAILY_ENABLED" == true ]]; then
        DAILY_ENABLED=false
    else
        DAILY_ENABLED=true
    fi
    saveConfig
}

toggleWeekly() {
    if [[ "$WEEKLY_ENABLED" == true ]]; then
        WEEKLY_ENABLED=false
    else
        WEEKLY_ENABLED=true
    fi
    saveConfig
}

toggleMonthly() {
    if [[ "$MONTHLY_ENABLED" == true ]]; then
        MONTHLY_ENABLED=false
    else
        MONTHLY_ENABLED=true
    fi
    saveConfig
}

setDailyCount() {
    read -p "Enter number of daily backups to keep (1-30): " count
    [[ "$count" =~ ^[0-9]+$ ]] && [[ "$count" -ge 1 ]] && [[ "$count" -le 30 ]] && {
        DAILY_BACKUPS=$count
        saveConfig
    }
}

setWeeklyCount() {
    read -p "Enter number of weekly backups to keep (1-52): " count
    [[ "$count" =~ ^[0-9]+$ ]] && [[ "$count" -ge 1 ]] && [[ "$count" -le 52 ]] && {
        WEEKLY_BACKUPS=$count
        saveConfig
    }
}

setMonthlyCount() {
    read -p "Enter number of monthly backups to keep (1-24): " count
    [[ "$count" =~ ^[0-9]+$ ]] && [[ "$count" -ge 1 ]] && [[ "$count" -le 24 ]] && {
        MONTHLY_BACKUPS=$count
        saveConfig
    }
}

restoreSnapshot() {
    local snapshot="$1"
    local choice=$(echo -e "ðŸ”„ Restore\nâŒ Cancel" | fzf --layout=reverse --prompt="Restore $snapshot? This will overwrite current system! " --height=30%)
    
    [[ "$choice" =~ "Restore" ]] && {
        yprint --color=red "Restoring snapshot: $snapshot"
        echo "This will overwrite your current system!"
        read -p "Type 'RESTORE' to confirm: " confirm
        
        [[ "$confirm" == "RESTORE" ]] && {
            rsync -avH --progress --delete "$DESTINATION/$snapshot/" /
            yprint --color=green "Restore completed!"
        }
        read -p "Press Enter to continue..."
    }
}

deleteSnapshot() {
    local snapshot="$1"
    local choice=$(echo -e "ðŸ—‘ï¸ Delete\nâŒ Cancel" | fzf --layout=reverse --prompt="Delete $snapshot? " --height=30%)
    
    [[ "$choice" =~ "Delete" ]] && {
        rm -rf "$DESTINATION/$snapshot"
        yprint --color=green "Snapshot deleted!"
        read -p "Press Enter to continue..."
    }
}

renameSnapshot() {
    local snapshot="$1"
    read -p "Enter new name: " new_name
    [[ -n "$new_name" ]] && {
        mv "$DESTINATION/$snapshot" "$DESTINATION/$new_name"
        yprint --color=green "Snapshot renamed!"
        read -p "Press Enter to continue..."
    }
}

viewSnapshotDetails() {
    local snapshot="$1"
    local snapshot_path="$DESTINATION/$snapshot"
    
    echo "Snapshot: $snapshot"
    echo "Path: $snapshot_path"
    echo "Size: $(du -sh "$snapshot_path" 2>/dev/null | cut -f1)"
    echo "Created: $(stat -c %y "$snapshot_path" 2>/dev/null)"
    echo "Files: $(find "$snapshot_path" -type f 2>/dev/null | wc -l)"
    
    read -p "Press Enter to continue..."
}

snapshotMenu() {
    local snapshot="$1"
    
    while true; do
        clear
        yprint -c --color=yellow "Snapshot: $snapshot"
        
        choice=$(echo -e "ðŸ”„ Restore This Snapshot\nðŸ—‘ï¸ Delete Snapshot\nâœï¸ Rename Snapshot\nðŸ“‹ View Snapshot Details\nðŸ”™ Back to Main Menu" | fzf \
            --layout=reverse \
            --prompt="ðŸ“¸ Select action > " \
            --height=50%)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Restore"*) restoreSnapshot "$snapshot" ;;
            *"Delete"*) deleteSnapshot "$snapshot"; break ;;
            *"Rename"*) renameSnapshot "$snapshot"; break ;;
            *"View"*) viewSnapshotDetails "$snapshot" ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    loadConfig
    
    while true; do
        clear
        yprint -c --color=yellow "YoUNiX $TITLE"
        
        # Build dynamic menu
        local dest_text="ðŸ“ Select Destination"
        [[ -n "$DESTINATION" ]] && dest_text="ðŸ“ Change Destination ($DESTINATION)"
        
        local daily_text="ðŸ“… Enable Daily Backups"
        [[ "$DAILY_ENABLED" == true ]] && daily_text="ðŸ“… Disable Daily Backups"
        
        local weekly_text="ðŸ“† Enable Weekly Backups"
        [[ "$WEEKLY_ENABLED" == true ]] && weekly_text="ðŸ“† Disable Weekly Backups"
        
        local monthly_text="ðŸ—“ï¸ Enable Monthly Backups"
        [[ "$MONTHLY_ENABLED" == true ]] && monthly_text="ðŸ—“ï¸ Disable Monthly Backups"
        
        # Build options
        local options="ðŸ“¸ Create Snapshot\n$dest_text\n$daily_text"
        [[ "$DAILY_ENABLED" == true ]] && options="$options\nðŸ“Š Keep $DAILY_BACKUPS Daily Backups"
        options="$options\n$weekly_text"
        [[ "$WEEKLY_ENABLED" == true ]] && options="$options\nðŸ“Š Keep $WEEKLY_BACKUPS Weekly Backups"
        options="$options\n$monthly_text"
        [[ "$MONTHLY_ENABLED" == true ]] && options="$options\nðŸ“Š Keep $MONTHLY_BACKUPS Monthly Backups"
        options="$options\nðŸšª Exit"
        
        # Add snapshots if destination exists
        if [[ -n "$DESTINATION" && -d "$DESTINATION" ]]; then
            local snapshots=$(ls -1t "$DESTINATION"/snapshot-* 2>/dev/null)
            [[ -n "$snapshots" ]] && options="$options\n$snapshots"
        fi
        
        height=$(($(tput lines) - 1))
        
        choice=$(echo -e "$options" | fzf \
            --layout=reverse \
            --prompt="â° Select option > " \
            --height=$height)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Create Snapshot"*) createSnapshot ;;
            *"Destination"*) selectDestination ;;
            *"Daily Backups"*) toggleDaily ;;
            *"Keep"*" Daily"*) setDailyCount ;;
            *"Weekly Backups"*) toggleWeekly ;;
            *"Keep"*" Weekly"*) setWeeklyCount ;;
            *"Monthly Backups"*) toggleMonthly ;;
            *"Keep"*" Monthly"*) setMonthlyCount ;;
            *"Exit"*) exit 0 ;;
            snapshot-*) snapshotMenu "$(basename "$choice")" ;;
        esac
    done
}

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu