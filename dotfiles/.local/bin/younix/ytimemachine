#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Time Machine
#

SCRIPT_NAME=$(basename "$0")
TITLE="Time Machine"
BASE_FOLDER_NAME="time-machine"
CONFIG_DIR="$HOME/.config/$BASE_FOLDER_NAME"
CONFIG_FILE="$CONFIG_DIR/config"

# Default values
DESTINATION=""
DAILY_ENABLED=false
WEEKLY_ENABLED=false
MONTHLY_ENABLED=false
DAILY_BACKUPS=7
WEEKLY_BACKUPS=4
MONTHLY_BACKUPS=12

showHelp() {
    echo "YoUNiX $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=80 --lines=30 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

loadConfig() {
    mkdir -p "$CONFIG_DIR"
    [[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"
}

saveConfig() {
    cat > "$CONFIG_FILE" << EOF
DESTINATION="$DESTINATION"
DAILY_ENABLED=$DAILY_ENABLED
WEEKLY_ENABLED=$WEEKLY_ENABLED
MONTHLY_ENABLED=$MONTHLY_ENABLED
DAILY_BACKUPS=$DAILY_BACKUPS
WEEKLY_BACKUPS=$WEEKLY_BACKUPS
MONTHLY_BACKUPS=$MONTHLY_BACKUPS
EOF
}

selectDestination() {
    local choice=$(echo -e "ðŸ“ Browse for folder\nðŸ’¾ Enter path manually" | fzf --layout=reverse --prompt="Select destination method > " --height=30%)
    
    case "$choice" in
        *"Browse"*)
            DESTINATION=$(find /mnt /media /home -maxdepth 3 -type d 2>/dev/null | fzf --layout=reverse --prompt="Select backup destination > " --height=50%)
            ;;
        *"Enter path"*)
            read -p "Enter backup destination path: " DESTINATION
            ;;
    esac
    
    [[ -n "$DESTINATION" ]] && {
        sudo mkdir -p "$DESTINATION/$BASE_FOLDER_NAME"
        sudo chmod 755 "$DESTINATION/$BASE_FOLDER_NAME"
        DESTINATION="$DESTINATION/$BASE_FOLDER_NAME"
        saveConfig
        yprint --color=green "Destination set to: $DESTINATION"
        read -p "Press Enter to continue..."
    }
}

createSnapshot() {
    clear
    [[ -z "$DESTINATION" ]] && { yprint --color=red "No destination selected"; read -p "Press Enter..."; return; }
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local snapshot_name="$timestamp-time-machine-snapshot"
    local snapshot_path="$DESTINATION/$snapshot_name"
    
    # Find latest snapshot for hardlinks
    local latest_snapshot=$(ls -1t "$DESTINATION"/snapshot-* 2>/dev/null | head -1)
    
    yprint --color=yellow "Creating snapshot: $snapshot_name"
    echo
    
    # Build rsync command (silent)
    local rsync_cmd="sudo rsync -avH --delete --quiet"
    rsync_cmd="$rsync_cmd --exclude={'/dev/*','/proc/*','/sys/*','/tmp/*','/run/*','/mnt/*','/media/*','/lost+found'}"
    
    [[ -n "$latest_snapshot" ]] && rsync_cmd="$rsync_cmd --link-dest=$latest_snapshot"
    
    rsync_cmd="$rsync_cmd / $snapshot_path/"
    
    # Start progress bar animation
    local frames=(
        "[    ] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[=   ] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[==  ] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[=== ] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[====] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[ ===] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[  ==] ðŸ“¸ Backing up files... (Press 'A' to abort)"
        "[   =] ðŸ“¸ Backing up files... (Press 'A' to abort)"
    )
    local i=0
    eval $rsync_cmd &
    
    local rsync_pid=$!
    
    while kill -0 $rsync_pid 2>/dev/null; do
        printf "\r%s" "${frames[$i]}"
        i=$(((i+1) % ${#frames[@]}))
        
        # Check for abort key press
        read -t 0.2 -n 1 key 2>/dev/null
        if [[ "$key" == "A" || "$key" == "a" ]]; then
            kill $rsync_pid 2>/dev/null
            printf "\r"
            yprint --color=red "ï‘®  Snapshot creation aborted!"
            read -p "Press Enter to continue..."
            return
        fi
    done
    
    wait $rsync_pid
    local exit_code=$?
    
    printf "\r"
    if [[ $exit_code -eq 0 ]]; then
        yprint --color=green "îª²  Snapshot created successfully!"
    else
        yprint --color=red "ó°¬…  Snapshot creation failed!"
    fi
    
    read -p "Press Enter to continue..."
}

toggleDaily() {
    if [[ "$DAILY_ENABLED" == true ]]; then
        DAILY_ENABLED=false
    else
        DAILY_ENABLED=true
    fi
    saveConfig
}

toggleWeekly() {
    if [[ "$WEEKLY_ENABLED" == true ]]; then
        WEEKLY_ENABLED=false
    else
        WEEKLY_ENABLED=true
    fi
    saveConfig
}

toggleMonthly() {
    if [[ "$MONTHLY_ENABLED" == true ]]; then
        MONTHLY_ENABLED=false
    else
        MONTHLY_ENABLED=true
    fi
    saveConfig
}

setDailyCount() {
    local count=$(seq 1 7 | fzf --layout=reverse --prompt="Select daily backups to keep > " --height=30%)
    [[ -n "$count" ]] && {
        DAILY_BACKUPS=$count
        saveConfig
    }
}

setWeeklyCount() {
    local count=$(seq 1 4 | fzf --layout=reverse --prompt="Select weekly backups to keep > " --height=30%)
    [[ -n "$count" ]] && {
        WEEKLY_BACKUPS=$count
        saveConfig
    }
}

setMonthlyCount() {
    local count=$(seq 1 12 | fzf --layout=reverse --prompt="Select monthly backups to keep > " --height=30%)
    [[ -n "$count" ]] && {
        MONTHLY_BACKUPS=$count
        saveConfig
    }
}

restoreSnapshot() {
    local snapshot="$1"
    local choice=$(echo -e "ó°¦›  Restore\nó°¬…  Cancel" | fzf --layout=reverse --prompt="Restore $snapshot? This will overwrite current system! " --height=30%)
    
    [[ "$choice" =~ "Restore" ]] && {
        yprint --color=red "Restoring snapshot: $snapshot"
        echo "This will overwrite your current system!"
        read -p "Type 'RESTORE' to confirm: " confirm
        
        [[ "$confirm" == "RESTORE" ]] && {
            rsync -avH --progress --delete "$DESTINATION/$snapshot/" /
            yprint --color=green "Restore completed!"
        }
        read -p "Press Enter to continue..."
    }
}

deleteSnapshot() {
    local snapshot="$1"
    local choice=$(echo -e "ó°†´  Delete\nó°¬…  Cancel" | fzf --layout=reverse --prompt="Delete $snapshot? " --height=30%)
    
    [[ "$choice" =~ "Delete" ]] && {
        # remove with no output
        echo
        sudo rm -rf "$DESTINATION/$snapshot" 2>/dev/null
        yprint --color=green "Snapshot deleted!"
        echo
        read -p "Press Enter to continue..."
    }
}

renameSnapshot() {
    local snapshot="$1"
    local timestamp=$(echo "$snapshot" | cut -d'-' -f1)
    read -p "Enter new name: " new_name
    [[ -n "$new_name" ]] && {
        local new_snapshot="$timestamp-$new_name"
        sudo mv "$DESTINATION/$snapshot" "$DESTINATION/$new_snapshot"
        yprint --color=green "Snapshot renamed!"
        read -p "Press Enter to continue..."
    }
}

viewSnapshotDetails() {
    local snapshot="$1"
    local snapshot_path="$DESTINATION/$snapshot"
    
    echo "Snapshot: $snapshot"
    echo "Path: $snapshot_path"
    echo "Size: $(du -sh "$snapshot_path" 2>/dev/null | cut -f1)"
    echo "Created: $(stat -c %y "$snapshot_path" 2>/dev/null)"
    echo "Files: $(find "$snapshot_path" -type f 2>/dev/null | wc -l)"
    
    read -p "Press Enter to continue..."
}

snapshotMenu() {
    local snapshot="$1"
    
    while true; do
        clear
        yprint -c --color=yellow "Snapshot: $snapshot"
        
        choice=$(echo -e "ó°¦›  Restore This Snapshot\nó°†´  Delete Snapshot\nó°‘•  Rename Snapshot\nî©°  View Snapshot Details\nó°Œ  Back to Main Menu" | fzf \
            --layout=reverse \
            --prompt="ï€‚  Select action > " \
            --height=50%)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Restore"*) restoreSnapshot "$snapshot" ;;
            *"Delete"*) deleteSnapshot "$snapshot"; break ;;
            *"Rename"*) renameSnapshot "$snapshot"; break ;;
            *"View"*) viewSnapshotDetails "$snapshot" ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    loadConfig
    
    while true; do
        sudo clear
        
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        # Build dynamic menu
        local dest_text="î—¿  Select Destination first!"
        [[ -n "$DESTINATION" ]] && dest_text="î—¿  Change Destination ($DESTINATION)"
        
        local daily_text="ï”¢  Enable Daily Backups"
        [[ "$DAILY_ENABLED" == true ]] && daily_text="ï”¢  Disable Daily Backups"
        
        local weekly_text="î¼¸  Enable Weekly Backups"
        [[ "$WEEKLY_ENABLED" == true ]] && weekly_text="î¼¸  Disable Weekly Backups"
        
        local monthly_text="ó°¸—  Enable Monthly Backups"
        [[ "$MONTHLY_ENABLED" == true ]] && monthly_text="ó°¸—  Disable Monthly Backups"
        
        # Build options
        local options="$dest_text\nó°ˆ†   Exit"
        
        if [[ -n "$DESTINATION" ]]; then
            options="ó°†“  Create Snapshot\n$dest_text\n$daily_text"
            [[ "$DAILY_ENABLED" == true ]] && options="$options\nó°«  Keep $DAILY_BACKUPS Daily Backups"
            options="$options\n$weekly_text"
            [[ "$WEEKLY_ENABLED" == true ]] && options="$options\nó°«  Keep $WEEKLY_BACKUPS Weekly Backups"
            options="$options\n$monthly_text"
            [[ "$MONTHLY_ENABLED" == true ]] && options="$options\nó°«  Keep $MONTHLY_BACKUPS Monthly Backups"
            options="$options\nó°ˆ†  Exit"
        fi
        
        # Add snapshots if destination exists
        if [[ -n "$DESTINATION" && -d "$DESTINATION" ]]; then
            local snapshots=$(ls -1t "$DESTINATION"/ 2>/dev/null | xargs -r -n1 basename)
            [[ -n "$snapshots" ]] && options="$options\n$snapshots"
        fi
        
        height=$(($(tput lines) - 1))
        
        choice=$(echo -e "$options" | fzf \
            --layout=reverse \
            --prompt="ï€‚  Select option > " \
            --height=50%)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Create Snapshot"*) createSnapshot ;;
            *"Destination"*) selectDestination ;;
            *"Keep"*" Daily"*) setDailyCount ;;
            *"Keep"*" Weekly"*) setWeeklyCount ;;
            *"Keep"*" Monthly"*) setMonthlyCount ;;
            *"Daily Backups"*) toggleDaily ;;
            *"Weekly Backups"*) toggleWeekly ;;
            *"Monthly Backups"*) toggleMonthly ;;
            *"Exit"*) exit 0 ;;
            *-*) snapshotMenu "$choice" ;;
        esac
    done
}

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu