#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Suspend
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure Suspend"
CONF="/etc/systemd/logind.conf"

CURRENT_AUTOSUSPEND_TIME=$(systemd-inhibit --list | grep 'sleep.target' | awk '{print $5}')


showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Current Autosuspend: $CURRENT_AUTOSUSPEND_TIME "
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -s           Set autosuspend time"
    echo "  -h           Show this help"
    echo "  -n           Show notification"
    echo "  -v           Show console message"
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "⚡ Auto-Suspend Changed" "Now: $1"
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "⚡ Auto-Suspend Changed\nNow: $1"
    fi
}

change() {
    sudo cp "$CONF" "${CONF}.bak"

    if [ "$1" = "never" ]; then
        disable
        printMessage "Never"
    else
        set "$1"
        printMessage "$1"
    fi
    systemctl restart systemd-logind
    echo "Done. You can test by running: sudo loginctl idle-time"

}

set() {
    # Ensure lines exist or replace them
    if grep -q "^#*IdleAction=" "$CONF"; then
        sudo sed -i 's/^#*IdleAction=.*/IdleAction=suspend/' "$CONF"
    else
        sudo echo "IdleAction=suspend" >> "$CONF"
    fi

    if grep -q "^#*IdleActionSec=" "$CONF"; then
        sudo sed -i 's/^#*IdleActionSec=.*/IdleActionSec=20min/' "$CONF"
    else
        sudo echo "IdleActionSec=$1" >> "$CONF"
    fi
}

disable(){
    # Comment out or reset the lines
    if grep -q "^IdleAction=" "$CONF"; then
        sudo sed -i 's/^IdleAction=.*/#IdleAction=ignore/' "$CONF"
    else
        sudo echo "#IdleAction=ignore" >> "$CONF"
    fi

    if grep -q "^IdleActionSec=" "$CONF"; then
        sudo sed -i 's/^IdleActionSec=.*/#IdleActionSec=30min/' "$CONF"
    else
        sudo echo "#IdleActionSec=30min" >> "$CONF"
    fi
}

displayMenu() {
    while true; do
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        CURRENT_AUTOSUSPEND_TIME=$(systemd-inhibit --list | grep 'sleep.target' | awk '{print $5}')

        yprint -c --color=yellow "Auto-Suspend: $CURRENT_AUTOSUSPEND_TIME"
        height=$(($(tput lines) - 2))
        choice=$(echo -e "󰹆  Never\n  5 min\n  15 min\n  30 min\n$EXIT_TEXT" | fzf --layout=reverse --prompt=" Auto-Suspend > " --height=$height)
        [ -z "$choice" ] && exit 0
        
        case "$choice" in
            *Never*) change never ;;
            *5*) change 5min ;;
            *15*) change 15min ;;
            *30*) change 30min ;;
            *) break ;;
        esac
    done
}

OPEN_TERMINAL=false
SET=""
EXIT_TEXT="󰈆  Exit"

while getopts "ethnvs:" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    case "$SET" in
        never|5min|15min|30min) change "$SET" ;;
        *) echo "Invalid suspend time. Use 'never', '5min', '15min', or '30min'."; exit 1 ;;
    esac
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu