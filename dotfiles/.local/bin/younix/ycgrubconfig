#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX GRUB Config
#

SCRIPT_NAME=$(basename "$0")
TITLE="GRUB Configuration"
GRUB_CONFIG="/etc/default/grub"

showHelp() {
    echo "YoUNiX $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=100 --lines=30 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

updateGrubConfig() {
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    yprint --color=green "GRUB configuration updated!"
    read -p "Press Enter to continue..."
}

setDefault() {
    local entries=$(awk -F\' '/menuentry / {print NR-1 ": " $2}' /boot/grub/grub.cfg 2>/dev/null || echo "0: Default")
    local choice=$(echo "$entries" | fzf --layout=reverse --prompt="Select default entry > " --height=50%)
    [[ -n "$choice" ]] && {
        local index=$(echo "$choice" | cut -d: -f1)
        sudo sed -i "s/^GRUB_DEFAULT=.*/GRUB_DEFAULT=$index/" "$GRUB_CONFIG"
        updateGrubConfig
    }
}

setSaveDefault() {
    local choice=$(echo -e "true\nfalse" | fzf --layout=reverse --prompt="Save last selected entry? > " --height=30%)
    [[ -n "$choice" ]] && {
        sudo sed -i "s/^GRUB_SAVEDEFAULT=.*/GRUB_SAVEDEFAULT=$choice/" "$GRUB_CONFIG"
        grep -q "^GRUB_SAVEDEFAULT=" "$GRUB_CONFIG" || echo "GRUB_SAVEDEFAULT=$choice" | sudo tee -a "$GRUB_CONFIG" > /dev/null
        updateGrubConfig
    }
}

setTimeout() {
    while true; do
        echo "Press Ctrl+C to cancel"
        read -e -p "Enter timeout in seconds (0-30): " timeout
        if [[ "$timeout" =~ ^[0-9]+$ ]] && [[ "$timeout" -le 30 ]]; then
            sudo sed -i "s/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=$timeout/" "$GRUB_CONFIG"
            updateGrubConfig
            break
        else
            yprint --color=red "Invalid input. Please enter a number between 0-30."
        fi
    done
}

setTimeoutStyle() {
    local choice=$(echo -e "menu\ncountdown\nhidden" | fzf --layout=reverse --prompt="Select timeout style > " --height=30%)
    [[ -n "$choice" ]] && {
        sudo sed -i "s/^GRUB_TIMEOUT_STYLE=.*/GRUB_TIMEOUT_STYLE=$choice/" "$GRUB_CONFIG"
        grep -q "^GRUB_TIMEOUT_STYLE=" "$GRUB_CONFIG" || echo "GRUB_TIMEOUT_STYLE=$choice" | sudo tee -a "$GRUB_CONFIG" > /dev/null
        updateGrubConfig
    }
}

setKernelParams() {
    local current=$(grep "^GRUB_CMDLINE_LINUX_DEFAULT=" "$GRUB_CONFIG" | cut -d'"' -f2)
    read -e -p "Enter kernel parameters: " -i "$current" params
    [[ -n "$params" ]] && {
        sudo sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT=\"$params\"/" "$GRUB_CONFIG"
        updateGrubConfig
    }
}

setLogLevel() {
    local choice=$(echo -e "quiet\nloglevel=3\nloglevel=7" | fzf --layout=reverse --prompt="Select log level > " --height=30%)
    [[ -n "$choice" ]] && {
        local current=$(grep "^GRUB_CMDLINE_LINUX_DEFAULT=" "$GRUB_CONFIG" | cut -d'"' -f2)
        local new_params=$(echo "$current" | sed 's/quiet//g; s/loglevel=[0-9]//g' | sed 's/  */ /g; s/^ *//; s/ *$//')
        [[ "$choice" != "loglevel=7" ]] && new_params="$new_params $choice"
        sudo sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT=\"$new_params\"/" "$GRUB_CONFIG"
        updateGrubConfig
    }
}

setGfxMode() {
    local choice=$(echo -e "auto\n1920x1080\n1366x768\n1024x768\n800x600" | fzf --layout=reverse --prompt="Select resolution > " --height=50%)
    [[ -n "$choice" ]] && {
        sudo sed -i "s/^GRUB_GFXMODE=.*/GRUB_GFXMODE=$choice/" "$GRUB_CONFIG"
        grep -q "^GRUB_GFXMODE=" "$GRUB_CONFIG" || echo "GRUB_GFXMODE=$choice" | sudo tee -a "$GRUB_CONFIG" > /dev/null
        updateGrubConfig
    }
}

toggleRecovery() {
    if grep -q "^GRUB_DISABLE_RECOVERY=true" "$GRUB_CONFIG"; then
        sudo sed -i "s/^GRUB_DISABLE_RECOVERY=.*/GRUB_DISABLE_RECOVERY=false/" "$GRUB_CONFIG"
        yprint --color=green "Recovery mode enabled"
    else
        sudo sed -i "s/^GRUB_DISABLE_RECOVERY=.*/GRUB_DISABLE_RECOVERY=true/" "$GRUB_CONFIG"
        grep -q "^GRUB_DISABLE_RECOVERY=" "$GRUB_CONFIG" || echo "GRUB_DISABLE_RECOVERY=true" | sudo tee -a "$GRUB_CONFIG" > /dev/null
        yprint --color=green "Recovery mode disabled"
    fi
    updateGrubConfig
}

toggleSubmenu() {
    if grep -q "^GRUB_DISABLE_SUBMENU=true" "$GRUB_CONFIG"; then
        sudo sed -i "s/^GRUB_DISABLE_SUBMENU=.*/GRUB_DISABLE_SUBMENU=false/" "$GRUB_CONFIG"
        yprint --color=green "Submenu enabled"
    else
        sudo sed -i "s/^GRUB_DISABLE_SUBMENU=.*/GRUB_DISABLE_SUBMENU=true/" "$GRUB_CONFIG"
        grep -q "^GRUB_DISABLE_SUBMENU=" "$GRUB_CONFIG" || echo "GRUB_DISABLE_SUBMENU=true" | sudo tee -a "$GRUB_CONFIG" > /dev/null
        yprint --color=green "Submenu disabled"
    fi
    updateGrubConfig
}

resetDefaults() {
    local choice=$(echo -e "Reset\nCancel" | fzf --layout=reverse --prompt="Reset GRUB to defaults? " --height=30%)
    [[ "$choice" == "Reset" ]] && {
        sudo cp "$GRUB_CONFIG" "$GRUB_CONFIG.backup"
        cat << 'EOF' | sudo tee "$GRUB_CONFIG" > /dev/null
GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="Arch"
GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet"
GRUB_CMDLINE_LINUX=""
GRUB_PRELOAD_MODULES="part_gpt part_msdos"
GRUB_TIMEOUT_STYLE=menu
GRUB_TERMINAL_INPUT=console
GRUB_GFXMODE=auto
GRUB_GFXPAYLOAD_LINUX=keep
GRUB_DISABLE_RECOVERY=false
EOF
        updateGrubConfig
        yprint --color=green "GRUB reset to defaults (backup saved as $GRUB_CONFIG.backup)"
    }
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "YoUNiX $TITLE"
        
        # Check current states
        local save_default_text="Save Default"
        grep -q "^GRUB_SAVEDEFAULT=true" "$GRUB_CONFIG" && save_default_text="Don't Save Default"
        
        local submenu_text="Show Submenus"
        grep -q "^GRUB_DISABLE_SUBMENU=true" "$GRUB_CONFIG" && submenu_text="Don't Show Submenus"
        
        local recovery_text="Enable Recovery Mode"
        grep -q "^GRUB_DISABLE_RECOVERY=true" "$GRUB_CONFIG" || recovery_text="Disable Recovery Mode"
        
        height=$(($(tput lines) - 1))
        
        choice=$(echo -e "î™Ž  Set Default Entry\nïˆ„  $save_default_text\nî™  Set Timeout\nó±Ž«ðŸŽ¨ Timeout Style\nî‰¦  Kernel Parameters\nó°¦ª  Log Level\nó°¹  GFX Mode\nïˆ„  $recovery_text\nó°  $submenu_text\nî«’  Reset to Defaults\nó°Œ  Back" | fzf \
            --layout=reverse \
            --prompt="âš™ï¸  Select option > " \
            --height=$height)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Set Default Entry"*) setDefault ;;
            *"Save Default"*|*"Don't Save Default"*) setSaveDefault ;;
            *"Set Timeout"*) setTimeout ;;
            *"Timeout Style"*) setTimeoutStyle ;;
            *"Kernel Parameters"*) setKernelParams ;;
            *"Log Level"*) setLogLevel ;;
            *"GFX Mode"*) setGfxMode ;;
            *"Recovery"*) toggleRecovery ;;
            *"Submenus"*) toggleSubmenu ;;
            *"Reset to Defaults"*) resetDefaults ;;
            *"Back"*) exit 0 ;;
        esac
    done
}

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu