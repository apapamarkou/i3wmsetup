#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Configure Hyprland window borders
#

MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Configure Hyprland window borders"

# --- Hyprland Specific Variables ---
HYPRLAND_CONFIG_FILE="$HOME/.config/hypr/look.conf"
# This function is a placeholder for yprint, which likely isn't available
yprint() {
    echo "$@"
}
# -----------------------------------

showHelp() {
    echo "$TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal (functionality not implemented in this Hyprland conversion)"
    echo "  -s           Set theme (thin/normal/thick)"
    echo "  -h           Show this help"
    echo "  -n           Suppress notification"
    echo "  -v           Suppress console message"
    echo "Arguments can be combined: -vn, -nv, etc."
}

# The openTerminal function is skipped as it relies on specific environment variables (LOCK_DIR, FLOATING_PREFIX)
# and a 'terminal' command that isn't universally defined, making a direct Hyprland port complex without more context.

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "Window borders changed to $1" "Configuration updated in $HYPRLAND_CONFIG_FILE."
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "Window borders changed to $1.\nConfiguration updated in $HYPRLAND_CONFIG_FILE."
    fi
}

# Function to replace or add a Hyprland keyword in the config file
update_hyprland_config() {
    local key="$1"
    local value="$2"
    local config_file="$HYPRLAND_CONFIG_FILE"

    if grep -q "^\s*${key}\s*=" "$config_file"; then
        # Replace existing line (handles potential whitespace before the key)
        sed -i "s/^\s*${key}\s*=.*/${key} = ${value}/" "$config_file"
    else
        # If the key isn't found, append it to the end of the file
        echo -e "\n${key} = ${value}" >> "$config_file"
    fi
}


change() {
    local border_name="$1"
    local borderSize=0

    case "$border_name" in
        thin)
            borderSize=1 ;;
        normal)
            borderSize=2 ;;
        thick)
            borderSize=4 ;;
        *)
            echo "Invalid border size: $border_name. Use 'thin', 'normal', or 'thick'."
            exit 1
            ;;
    esac
    
    # Apply setting immediately using hyprctl
    hyprctl keyword border_size "$borderSize" > /dev/null 2>&1
    
    # Update the configuration file
    update_hyprland_config "border_size" "$borderSize"
    
    printMessage "$border_name"
}

get_current_border_setting() {
    # Get current border_size from config file, falling back to 0 if not found
    local current_px=$(grep -oP '^\s*decoration:border_size\s*=\s*\K[0-9]+' "$HYPRLAND_CONFIG_FILE" 2>/dev/null | tail -n 1)
    current_px=${current_px:-0} # Default to 0 if no value is found (which is borderless)

    case "$current_px" in
        1) echo "Thin ($current_px)" ;;
        2) echo "Normal ($current_px)" ;;
        4) echo "Thick ($current_px)" ;;
        0) echo "None ($current_px)" ;;
        *) echo "Custom ($current_px)" ;;
    esac
}

displayMenu() {
    if ! command -v fzf &> /dev/null; then
        echo "Error: fzf is required for the interactive menu but is not installed."
        exit 1
    fi
    
    while true; do
        # clear
        yprint -c --color=yellow "$TITLE"
        
        current_word=$(get_current_border_setting)

        yprint -c --color=green "Current border size: $current_word   (ESC to exit)"

        # relative fzf height by terminal height
        height=$(($(tput lines) - 2))
        
        choice=$(echo -e "󰎦  Normal (2px)\n󰎩  Thin (1px)\n󰎬  Thick (4px)\n󰌍  Back" | fzf --layout=reverse --prompt="  Border Size > " --height=$height)
        case "$choice" in
            *Normal*) change normal ;;
            *Thin*) change thin ;;
            *Thick*) change thick ;;
            *) break ;;

        esac
    done
}

OPEN_TERMINAL=false
SET_MONITOR=""

while getopts "thnvs:" opt; do
    case $opt in
        t) 
            echo "-t (Open in terminal) is not implemented in the Hyprland conversion." 
            # OPEN_TERMINAL=true # Keep flag if future implementation is desired
            ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        s) SET="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET" ]; then
    case "$SET" in
        thin|normal|thick) change "$SET" ;;
        *) echo "Invalid border size. Use 'thin', 'normal', or 'thick'."; exit 1 ;;
    esac
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    # if you want to implement the terminal open logic later, do it here
    # openTerminal
    exit 0
fi

displayMenu