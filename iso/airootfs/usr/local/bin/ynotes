#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Notes
#

SCRIPT_NAME=$(basename "$0")
TITLE="Notes"
NOTES_DIR="$HOME/.config/ynotes"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=100 --lines=30 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

addNewNote() {
    clear
    yprint -c --color=yellow "Add New Note"
    echo
    read -e -p "Enter note title: " title
    [[ -z "$title" ]] && return
    
    # Create filename from title
    filename=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
    filepath="$NOTES_DIR/${filename}.md"
    
    # Create note with YAML frontmatter
    cat > "$filepath" << EOF
---
title: $title
startdate: $(date +%Y-%m-%d)
tags: []
---

### Content

Write your note here...

### Notes

EOF
    
    echo "Note created: $filepath"
}

showNotePreview() {
    local filepath="$1"
    [[ ! -f "$filepath" ]] && return
    
    local title=$(grep '^title:' "$filepath" | sed 's/title: //')
    local startdate=$(grep '^startdate:' "$filepath" | sed 's/startdate: //')
    local tags=$(grep '^tags:' "$filepath" | sed 's/tags: //')
    
    echo "Title: $title"
    echo "Start Date: $startdate"
    echo "Tags: $tags"
    echo ""
    echo "Content:"
    echo ""
    awk '/^---$/{f++; next} f==2{print}' "$filepath"
}

previewNote() {
    local note=$1
    note=${note#\'}
    note=${note%\'}

    [[ "$note" =~ (Add new note|Exit) ]] && return
    
    local filepath="$NOTES_DIR/$note"
    showNotePreview "$filepath"
}

editTitle() {
    local filepath="$1"
    local current_title=$(grep '^title:' "$filepath" | sed 's/title: //')
    read -e -p "Enter new title: " -i "$current_title" new_title
    [[ -n "$new_title" ]] && sed -i "s/^title:.*/title: $new_title/" "$filepath"
}

editStartDate() {
    local filepath="$1"
    local current_date=$(grep '^startdate:' "$filepath" | sed 's/startdate: //')
    read -e -p "Enter new start date (YYYY-MM-DD): " -i "$current_date" new_date
    # new_date=$(
    #     dialog --stdout --calendar "Select a Date (YYYY-DD-MM)" 0 0 | 
    #     xargs -r date '+%Y-%d-%m' -d
    # )
    [[ -n "$new_date" ]] && sed -i "s/^startdate:.*/startdate: $new_date/" "$filepath"
}

editTags() {
    local filepath="$1"
    local current_tags=$(grep '^tags:' "$filepath" | sed 's/tags: \[//;s/\]//' | tr ',' '\n' | sed 's/^ *//;s/ *$//')
    
    while true; do
        local options=$(echo -e "  Add Tag\n  Remove Tag\n  Save & Exit\n$current_tags")
        height=$(($(tput lines) - 1))
        choice=$(echo "$options" | fzf \
            --layout=reverse \
            --prompt="  > " \
            --height=$height)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Add Tag"*)
                read -e -p "Enter new tag: " new_tag
                [[ -n "$new_tag" ]] && current_tags=$(echo -e "$current_tags\n$new_tag")
                ;;
            *"Remove Tag"*)
                current_tags=$(echo "$current_tags" | grep -v "^$choice$")
                ;;
            *"Save & Exit"*)
                local tag_array=$(echo "$current_tags" | grep -v '^$' | paste -sd ',' | sed 's/,/, /g')
                sed -i "s/^tags:.*/tags: [$tag_array]/" "$filepath"
                break
                ;;
        esac
    done
}

editContent() {
    local filepath="$1"
    local tmpfile="/tmp/note_content_$$"
    
    # Extract content after YAML frontmatter
    awk '/^---$/{f++; next} f==2{print}' "$filepath" > "$tmpfile"
    
    # terminal --columns=120 --lines=40 --title="$FLOATING_PREFIX Edit Content" $TEXT_EDITOR "$tmpfile"
    $TEXT_EDITOR "$tmpfile"
    
    # Replace content in original file
    local yaml_end=$(grep -n '^---$' "$filepath" | tail -1 | cut -d: -f1)
    head -n "$yaml_end" "$filepath" > "${filepath}.tmp"
    cat "$tmpfile" >> "${filepath}.tmp"
    mv "${filepath}.tmp" "$filepath"
    rm -f "$tmpfile"
}

deleteNote() {
    local filepath="$1"
    local note=$(basename "$filepath")
    height=$(($(tput lines) - 1))
    choice=$(echo -e "󰆴  Delete\n󰜺  Cancel" | fzf \
        --layout=reverse \
        --prompt="Delete note '$note'? " \
        --height=$height)
    
    [[ "$choice" =~ "Delete" ]] && rm -f "$filepath"
}

noteMenu() {
    local note="$1"
    local filepath="$NOTES_DIR/$note"
    [[ ! -f "$filepath" ]] && return
    
    while true; do
        clear
        yprint -c --color=yellow "Edit Note: $note"
        height=$(($(tput lines) - 1))
        choice=$(echo -e "󰗴  Edit Title\n  Edit Start Date\n  Edit Tags\n󰦨  Edit Content\n󰆴  Delete Note\n󰌍  Back" | fzf \
            --layout=reverse \
            --prompt=" Select > " \
            --height=$height \
            --preview="bash -c \"showNotePreview '$filepath'\"" \
            --preview-window=right:70%:wrap)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Edit Title"*) editTitle "$filepath" ;;
            *"Edit Start Date"*) editStartDate "$filepath" ;;
            *"Edit Tags"*) editTags "$filepath" ;;
            *"Edit Content"*) editContent "$filepath" ;;
            *"Delete Note"*) deleteNote "$filepath" && break ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    mkdir -p "$NOTES_DIR"
    
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        height=$(($(tput lines) - 1))
        # Get list of notes
        local notes=$(find "$NOTES_DIR" -name "*.md" -type f -printf "%f\n" 2>/dev/null | sort)
        local options=$(echo -e "  Add new note\n󰿅 Exit\n$notes")
        
        choice=$(echo "$options" | fzf \
            --layout=reverse \
            --prompt=" Select > " \
            --height=$height \
            --preview='bash -c "previewNote \"{}\""' \
            --preview-window=right:70%:wrap)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Add new note"*)
                addNewNote
                ;;
            *"Exit"*)
                exit 0
                ;;
            *)
                noteMenu "$choice"
                ;;
        esac
    done
}

# Export functions for fzf
export -f previewNote
export -f showNotePreview
export NOTES_DIR

OPEN_TERMINAL=false

while getopts "th" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu