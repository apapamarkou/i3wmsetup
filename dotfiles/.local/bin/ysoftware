#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Software Manager
#

SCRIPT_NAME=$(basename "$0")
TITLE="Software Manager"
CONFIG_DIR="$HOME/.config/ysoftware"
PACKAGE_INFO="$CONFIG_DIR/package.info"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -r    Refresh package database"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=120 --lines=35 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

refreshPackages() {
    echo
    echo "Refreshing package database..."
    mkdir -p "$CONFIG_DIR"
    
    echo
    echo "Fetching official packages..."
    if pacman -Slq > "$PACKAGE_INFO.tmp" 2>/dev/null; then
        yprint --color=green "Official packages fetched successfully"
    else
        yprint --color=red "Warning: Failed to fetch official packages"
        touch "$PACKAGE_INFO.tmp"
        ERRORS=true
    fi
    
    echo
    if command -v yay >/dev/null 2>&1; then
        echo "Fetching AUR packages..."
        if yay -Slq --aur | sed 's/^/AUR:/' >> "$PACKAGE_INFO.tmp" 2>/dev/null; then
            yprint --color=green "AUR packages fetched successfully"
        else
            yprint --color=red "Warning: Failed to fetch AUR packages (service may be unavailable)"
            ERRORS=true
        fi
    fi
    
    mv "$PACKAGE_INFO.tmp" "$PACKAGE_INFO"
    
    echo
    echo "Package database updated!"
    echo
    # if ERRORS then press any key
    if [[ "$ERRORS" == true ]]; then
        read -n 1 -s -r -p "Press any key to continue..."
    else
        sleep 3
    fi
}

showSystemStats() {
    local total_available=$(wc -l < "$PACKAGE_INFO" 2>/dev/null || echo "0")
    local total_installed=$(pacman -Q | wc -l)
    local disk_space=$(df -h /var/cache/pacman/pkg | awk 'NR==2 {print $3}')
    
    yprint -c --color=yellow "  System Package Statistics"
    yprint -c --color=yellow "═══════════════════════════════"
    echo
    echo "  Total Packages Available: $total_available"
    echo "  Total Packages Installed: $total_installed"
    echo "󰏓  Available Disk Space: $disk_space"
    echo 
    echo "󰑐  Select 'Refresh Database' to update"
    echo "   the package list from repositories"
}

getPackageInfo() {
    local package=$1
    
    # Show stats for Refresh Database option
    if [[ "$1" =~ "Refresh Database" ]]; then
        showSystemStats
        return
    fi

    if [[ "$1" =~ "Exit" ]]; then
        echo "Press Enter here to exit..."
        return
    fi
    
    package=$(perl -pe 's/^(?:\[[^\]]*\]\s*)+//' <<< "$1")
    
    # Skip menu options
    [[ "$package" =~ ^(Exit)$ ]] && return
    
    # Show package info
    if [[ "$1" =~ \[AUR\] ]]; then
        yay -Si "$package" 2>/dev/null || echo "Package information not available"
    else
        pacman -Si "$package" 2>/dev/null || echo "Package information not available"
    fi
}



togglePackage() {
    echo
    text="$DISTRO_NAME  Software"
    cols=$(tput cols)                   # πλάτος τερματικού
    figured=$(figlet "$text")           # figlet output
    while IFS= read -r line; do
        printf "%*s\n" $(( (${#line} + cols) / 2 )) "$line"
    done <<< "$figured"
    
    local package="$1"
    local is_installed=false
    
    # Check if package is marked as installed
    if [[ "$package" =~ ^\[I\] ]]; then
        is_installed=true
    fi
    
    # Extract package name from format like "[I][Rep] package-name" or "[ ][Rep] package-name"
    package=$(echo "$package" | sed 's/^\(\[[^]]*\]\)* *//')
    if [[ "$1" =~ \[AUR\] ]]; then
        REPO="AUR"
    else
        REPO="Repositories"
    fi
    

    
    if [[ "$is_installed" == true ]]; then
        yprint --color=red -c "Uninstalling package: $package..."
        echo
        sudo pacman -R "$package"
    else
        yprint --color=green -c "Installing $package from $REPO..."
        echo
        if [[ "$1" =~ \[AUR\] ]]; then
            yay -S "$package"
        else
            sudo pacman -S "$package"
        fi
    fi
    
    read -p "Press Enter to continue..."
}

displayMenu() {
    # Check if package info exists
    if [[ ! -f "$PACKAGE_INFO" ]]; then
        refreshPackages
    fi
    
    while true; do
        clear
        height=$(($(tput lines) - 1))
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        # Create package list with installation status using join for speed
        local packages=$(pacman -Q | awk '{print $1}' | sort > /tmp/installed.tmp
        grep -v '^AUR:' "$PACKAGE_INFO" | sort > /tmp/official.tmp
        grep '^AUR:' "$PACKAGE_INFO" | sed 's/^AUR://' | sort > /tmp/aur.tmp
        
        # Official packages
        join -t' ' /tmp/installed.tmp /tmp/official.tmp | awk '{print "[I][Rep] " $1}'
        join -v2 -t' ' /tmp/installed.tmp /tmp/official.tmp | awk '{print "[ ][Rep] " $1}'
        
        # AUR packages
        join -t' ' /tmp/installed.tmp /tmp/aur.tmp | awk '{print "[I][AUR] " $1}'
        join -v2 -t' ' /tmp/installed.tmp /tmp/aur.tmp | awk '{print "[ ][AUR] " $1}'
        
        rm -f /tmp/installed.tmp /tmp/official.tmp /tmp/aur.tmp)
        
        local options=$(echo -e " Refresh Database\n󰿅 Exit\n$packages")
        
        choice=$(echo "$options" | fzf \
            --layout=reverse \
            --prompt=" Select package > " \
            --height=$height \
            --exact \
            --preview='bash -c "getPackageInfo $(printf "%s" "{}")"' \
            --preview-window=right:60%:wrap)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Refresh Database"*)
                refreshPackages
                ;;
            *"Exit"*)
                exit 0
                ;;
            *)
                togglePackage "$choice"
                ;;
        esac
    done
}

# Export functions for fzf
export -f getPackageInfo
export -f showSystemStats
export -f togglePackage
export PACKAGE_INFO

OPEN_TERMINAL=false
REFRESH=false

while getopts "rth" opt; do
    case $opt in
        r) REFRESH=true ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$REFRESH" == true ]]; then
    refreshPackages
    exit 0
fi

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu