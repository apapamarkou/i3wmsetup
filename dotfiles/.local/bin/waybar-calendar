#!/usr/bin/env bash

STATE="$HOME/.cache/waybar-calendar-state"
NAMEDAY_CACHE="$HOME/.cache/waybar-nameday"

# Initialize state file
if [[ ! -f "$STATE" ]]; then
    date "+%Y %m" > "$STATE"
fi

read YEAR MONTH < "$STATE"

# Handle clicks
case "$1" in
    prev)
        MONTH=$((MONTH - 1))
        if [[ $MONTH -lt 1 ]]; then
            MONTH=12
            YEAR=$((YEAR - 1))
        fi
        echo "$YEAR $MONTH" > "$STATE"
        ;;
    next)
        MONTH=$((MONTH + 1))
        if [[ $MONTH -gt 12 ]]; then
            MONTH=1
            YEAR=$((YEAR + 1))
        fi
        echo "$YEAR $MONTH" > "$STATE"
        ;;
esac

# Today's date
TODAY_DAY=$(date +%d)
TODAY_MONTH=$(date +%m)
TODAY_YEAR=$(date +%Y)

# Determine country code from LANG, lowercase, strip encoding
COUNTRY_CODE=$(echo "${LANG:-en_US}" | cut -d'_' -f2 | cut -d'.' -f1 | tr '[:upper:]' '[:lower:]')
[[ -z "$COUNTRY_CODE" ]] && COUNTRY_CODE="us"
COUNTRY_CODE_DISPLAY=$(echo "$COUNTRY_CODE" | tr '[:lower:]' '[:upper:]')

# Month and year title colored yellow
MONTH_NAME=$(date -d "$YEAR-$MONTH-01" "+%B")
TITLE="<span foreground=\"cyan\"><b>$MONTH_NAME $YEAR</b></span>"

# Calendar
CAL=$(cal -m "$MONTH" "$YEAR")

# Color day names (first line) cyan
CAL=$(echo "$CAL" | sed "1s@.*@$DAY_NAMES@")

# Highlight today's day yellow+bold if current month/year
if [[ "$YEAR" -eq "$TODAY_YEAR" && "$MONTH" -eq "$TODAY_MONTH" ]]; then
    TODAY_NUM=$(echo $TODAY_DAY | sed 's/^0*//')
    CAL=$(echo "$CAL" | sed "s/\b$TODAY_NUM\b/<span foreground=\\\"cyan\\\"><b>$TODAY_NUM<\\/b><\\/span>/")
fi

# Nameday caching
CACHE_DATE=""
[[ -f "$NAMEDAY_CACHE" ]] && CACHE_DATE=$(head -n1 "$NAMEDAY_CACHE")

if [[ "$CACHE_DATE" != "$TODAY_YEAR-$TODAY_MONTH-$TODAY_DAY" ]]; then
    NAMEDAYS=$(curl -s "https://nameday.abalin.net/api/V2/date?day=$TODAY_DAY&month=$TODAY_MONTH" \
        -H "Accept: application/json" \
        | jq -r ".data.$COUNTRY_CODE // empty")
    echo "$TODAY_YEAR-$TODAY_MONTH-$TODAY_DAY" > "$NAMEDAY_CACHE"
    echo "$NAMEDAYS" >> "$NAMEDAY_CACHE"
else
    NAMEDAYS=$(tail -n +2 "$NAMEDAY_CACHE")
fi

[[ -z "$NAMEDAYS" ]] && NAMEDAYS="-"

# Namedays title yellow
NAMEDAYS_TITLE="<span foreground=\"yellow\">\nNamedays for $COUNTRY_CODE_DISPLAY:</span>"

# Combine everything
CAL="$TITLE\n$CAL\n$NAMEDAYS_TITLE\n$NAMEDAYS"

# Escape for JSON
CAL_ESCAPED=$(printf "%s" "$CAL" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')

# Output JSON for Waybar
printf '{"text":"%s","tooltip":"\r   Next  Prev  \r\r%s\r"}' "$(date '+%H:%M:%S')" "$CAL_ESCAPED"
